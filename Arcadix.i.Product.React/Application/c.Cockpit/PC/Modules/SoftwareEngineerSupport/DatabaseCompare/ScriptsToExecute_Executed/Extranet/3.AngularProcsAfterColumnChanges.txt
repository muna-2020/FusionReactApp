        
        
ALTER PROCEDURE [dbo].[Proc_TestDrive_Certificate_CopyCertificate]         
(                                              
 @iMainClientId int,        
 @uCertificateTemplateId uniqueidentifier,        
 @iCertificateId int                                     
)                                              
AS                                               
BEGIN            
Declare         
@iNewCertificateId int,        
@uNewCertificateTemplateId uniqueidentifier,        
@iNewCertificatePrivilegeId int,        
@uNewCertificateTemplateFileId uniqueidentifier ,        
@uCertificateTemplateFileId uniqueidentifier,        
@iOrder int,        
@cAddHeaderFooter char(1),        
@cIsHeader char(1),        
@cIsFooter char(1),        
@tCertificateTemplateScript nvarchar(max),        
@cHasTemplateFileSpecificHeaderFooter char(1),        
@tCertificateTemplateFileHeader nvarchar(max),         
@tCertificateTemplateFileFooter nvarchar(max),        
@tCertificateTemplateHTML nvarchar(max),        
@iLanguageId int,         
@vFileName nvarchar(max),        
@vImageName nvarchar(500),        
@vbnImageData varbinary(max),        
@vImageType nvarchar(100),        
@iImageFileSize int,        
@uNewCertificateImageId uniqueidentifier,        
@uNewTextKeywordId uniqueidentifier,        
@uTextKeyWordId uniqueidentifier,        
@vKeyword nvarchar(500),        
@uUserId uniqueidentifier,        
@uTextSegmentId uniqueidentifier,        
@uNewTextSegmentId uniqueidentifier,        
@iStateId int,        
@uResultAttributeId uniqueidentifier,        
@iSubjectId int,        
@vConditionalOperator nvarchar(500),        
@dValue decimal(10,4),        
@vCertificateName nvarchar(200),        
@iCertificateDataId int        
 /********************************************************************************************                                                    
 Changed By:  R.Raghavendra Prasanna                                                    
 changed Date:  05.09.2014        
 Description: Copies the Certificate,Priviliges,Templates Assigned,Template Files,Template Images,TextSegments,Keywords        
        
 Modified By: Arvind K                                       
 Modified Date: 11/08/2020                                     
 Description: Included column list for Insert statements 
 ********************************************************************************************/                                                    
IF EXISTS (SELECT * FROM  t_TestDrive_Certificate WHERE iCertificateId = @iCertificateId and cIsDeleted='N' and uCertificateTemplateId=@uCertificateTemplateId)                          
BEGIN                        
--select * from t_TestDrive_Certificate        
Insert into t_TestDrive_Certificate (iMainClientId,	iOrderId,	cIsDeleted,	tDescription,	cIsActive,	iCertificateCode,	cIsPathfinder,	dtModifiedOn,	uUserId,	cIsForResultPage,	uCertificateTemplateId,	cIsForExtranet,	vCertificateProvider,	iPrivilegeId,	iNegativePrivilegeId,	iCombinationPrivilegeId,	cShowToAll,	cShowExplanation,	cGoDeep,	iCertificateTypeId,	vCustomDataClassName,	vCustomDataMethodName)
select @iMainClientId,iOrderId,cIsDeleted,tDescription,cIsActive,iCertificateCode,cIsPathfinder,GETDATE(),uUserId,cIsForResultPage,uCertificateTemplateId ,cIsForExtranet,vCertificateProvider,iPrivilegeId,iNegativePrivilegeId,iCombinationPrivilegeId,cShowToAll,cShowExplanation,cGoDeep,iCertificateTypeId ,vCustomDataClassName,vCustomDataMethodName       
from t_TestDrive_Certificate         
where iCertificateId = @iCertificateId and cIsDeleted='N' and uCertificateTemplateId=@uCertificateTemplateId        
Set @iNewCertificateId = @@IDENTITY        
        
        
--select * from t_TestDrive_Certificate_Data        
Insert into t_TestDrive_Certificate_Data select @iNewCertificateId,iLanguageId,vCertificateName from t_TestDrive_Certificate_Data         
where iCertificateId = @iCertificateId         
        
-- Update Certificate_Data vCertificateName to copy+name        
DECLARE curTempFile CURSOR  FOR SELECT iCertificateDataId,vCertificateName  FROM t_TestDrive_Certificate_Data WHERE iCertificateId=@iNewCertificateId        
OPEN  curTempFile          
     FETCH NEXT FROM curTempFile INTO @iCertificateDataId,@vCertificateName        
       WHILE(@@FETCH_STATUS <> -1)               
        BEGIN        
   Update t_TestDrive_Certificate_Data Set vCertificateName = 'Copy of '+@vCertificateName where iCertificateDataId= @iCertificateDataId           
          FETCH NEXT FROM curTempFile INTO @iCertificateDataId,@vCertificateName        
    END              
 Close curTempFile              
 DEALLOCATE curTempFile        
        
--select * from t_TestDrive_Certificate_Privilege        
Insert into t_TestDrive_Certificate_Privilege select iPrivilegeId,@iNewCertificateId,cShowExplanation,vExplanationFileName,vTheme,        
iNegativePrivilegeId,iCombinationPrivilegeId,cShowToAll,GETDATE(),uUserId,null from t_TestDrive_Certificate_Privilege         
where iCertificateId = @iCertificateId         
Set @iNewCertificatePrivilegeId = @@IDENTITY        
        
--select * from t_TestDrive_Certificate_Template        
Set @uNewCertificateTemplateId = newid()        
Insert into t_TestDrive_Certificate_Template select @uNewCertificateTemplateId,@iMainClientId,cIsDeleted,uUserId,getdate(),getdate(),        
tCertificateTemplateScript,null from t_TestDrive_Certificate_Template         
where uCertificateTemplateId = @uCertificateTemplateId         
        
-- Update t_TestDrive_Certificate with new templateId        
Update t_TestDrive_Certificate Set uCertificateTemplateId=@uNewCertificateTemplateId where iCertificateId = @iNewCertificateId        
        
-- Select * from t_TestDrive_Certificate_Template_Data        
Insert into t_TestDrive_Certificate_Template_Data select newid(),@uNewCertificateTemplateId,iLanguageId,vCertificateTemplateName,tCertificateHeaderHTML,tCertificateFooterHTML        
from t_TestDrive_Certificate_Template_Data         
where uCertificateTemplateId = @uCertificateTemplateId         
        
--select * from t_TestDrive_Certificate_Template_File        
DECLARE curTempFile CURSOR  FOR SELECT uCertificateTemplateFileId,uCertificateTemplateId,iOrder,cAddHeaderFooter,cIsHeader,cIsFooter,tCertificateTemplateScript,cHasTemplateFileSpecificHeaderFooter        
 FROM t_TestDrive_Certificate_Template_File WHERE uCertificateTemplateId=@uCertificateTemplateId        
OPEN  curTempFile          
     FETCH NEXT FROM curTempFile INTO @uCertificateTemplateFileId,@uCertificateTemplateId,@iOrder,@cAddHeaderFooter,@cIsHeader,@cIsFooter,@tCertificateTemplateScript,@cHasTemplateFileSpecificHeaderFooter        
       WHILE(@@FETCH_STATUS <> -1)               
        BEGIN        
   SET @uNewCertificateTemplateFileId = NEWID()        
           
   INSERT INTO t_TestDrive_Certificate_Template_File    
   values(@uNewCertificateTemplateFileId,@uNewCertificateTemplateId,@iOrder,@cAddHeaderFooter,@cIsHeader,@cIsFooter,@tCertificateTemplateScript,@cHasTemplateFileSpecificHeaderFooter,'N',null,null,null)    
            
    --select * from t_TestDrive_Certificate_Template_File_Data        
   Insert into t_TestDrive_Certificate_Template_File_Data select newid(),@uNewCertificateTemplateFileId,tCertificateTemplateFileHeader,tCertificateTemplateFileFooter,tCertificateTemplateHTML,iLanguageId,vFileName,vFileType,vbnFileData        
   from t_TestDrive_Certificate_Template_File_Data  where uCertificateTemplateFileId = @uCertificateTemplateFileId        
           
          FETCH NEXT FROM curTempFile INTO @uCertificateTemplateFileId,@uCertificateTemplateId,@iOrder,@cAddHeaderFooter,@cIsHeader,@cIsFooter,@tCertificateTemplateScript,@cHasTemplateFileSpecificHeaderFooter        
    END              
 Close curTempFile     
 DEALLOCATE curTempFile        
        
 --select * from t_TestDrive_Certificate_Template_Images        
DECLARE curTempFile CURSOR  FOR SELECT uCertificateTemplateId,vImageName,iOrder,vbnImageData,vImageType,iImageFileSize        
 FROM t_TestDrive_Certificate_Template_Images WHERE uCertificateTemplateId=@uCertificateTemplateId        
OPEN  curTempFile          
     FETCH NEXT FROM curTempFile INTO @uCertificateTemplateId,@vImageName,@iOrder,@vbnImageData,@vImageType,@iImageFileSize        
       WHILE(@@FETCH_STATUS <> -1)               
        BEGIN          
      Set @uNewCertificateImageId = newid()         
   INSERT INTO t_TestDrive_Certificate_Template_Images        
   values(@uNewCertificateImageId,@uNewCertificateTemplateId,@vImageName,@iOrder,null,@vImageType,@iImageFileSize)        
        
      Update t_TestDrive_Certificate_Template_Images set vbnImageData = @vbnImageData where uCertificateTemplateImageId=@uNewCertificateImageId        
           
          FETCH NEXT FROM curTempFile INTO @uCertificateTemplateId,@vImageName,@iOrder,@vbnImageData,@vImageType,@iImageFileSize        
    END              
 Close curTempFile              
 DEALLOCATE curTempFile        
        
  --select * from t_TestDrive_Certificate_TextKeyword where iMainclientId=101 and iCertificateId=98 AND cIsDeleted='N'        
        
 DECLARE curTempFile CURSOR  FOR SELECT uTextKeyWordId,vKeyword,uUserId        
 FROM t_TestDrive_Certificate_TextKeyword WHERE iMainClientId=@iMainClientId AND iCertificateId=@iCertificateId AND cIsDeleted='N'        
 OPEN  curTempFile          
  FETCH NEXT FROM curTempFile INTO @uTextKeyWordId,@vKeyword,@uUserId        
  WHILE(@@FETCH_STATUS <> -1)               
  BEGIN          
   Set @uNewTextKeywordId = newid()         
   INSERT INTO t_TestDrive_Certificate_TextKeyword        
   values(@uNewTextKeywordId,@iMainClientId,@iNewCertificateId,@vKeyword,@uUserId,getdate(),getdate(),'N',null)         
             
   --select * from t_TestDrive_Certificate_TextSegment        
   DECLARE curTemp CURSOR  FOR SELECT uTextSegmentId,uTextKeywordId,iOrder,iStateId FROM t_TestDrive_Certificate_TextSegment         
   WHERE uTextKeyWordId=@uTextKeyWordId AND cIsDeleted='N' and iMainClientId=@iMainClientId        
        
   OPEN  curTemp          
     FETCH NEXT FROM curTemp INTO @uTextSegmentId,@uTextKeywordId,@iOrder,@iStateId        
       WHILE(@@FETCH_STATUS <> -1)               
     BEGIN        
        
      SET @uNewTextSegmentId = NEWID()        
      INSERT INTO t_TestDrive_Certificate_TextSegment values(@uNewTextSegmentId,@iMainClientId,@uNewTextKeywordId,@iOrder,'N',@uUserId,GETDATE(),GETDATE(),@iStateId,null)         
        
      --select * from t_TestDrive_Certificate_TextSegment_Data        
      INSERT INTO t_TestDrive_Certificate_TextSegment_Data SELECT NEWID(),@uNewTextSegmentId,tTextSegment,tTextSegmentFemale,tTextSegmentMale,iLanguageId         
      from t_TestDrive_Certificate_TextSegment_Data  where uTextSegmentId= @uTextSegmentId        
        
      print @uTextSegmentId        
      print @uNewTextSegmentId        
      DECLARE curTempRule CURSOR  FOR SELECT uResultAttributeId,iSubjectId,vConditionalOperator,dValue FROM t_TestDrive_Certificate_TextSegmentRule WHERE uTextSegmentId=@uTextSegmentId        
      OPEN  curTempRule          
      FETCH NEXT FROM curTempRule INTO @uResultAttributeId,@iSubjectId,@vConditionalOperator,@dValue        
      WHILE(@@FETCH_STATUS <> -1)               
      BEGIN            
       INSERT INTO t_TestDrive_Certificate_TextSegmentRule SELECT NEWID(),@uNewTextSegmentId,@uResultAttributeId,@iSubjectId,@vConditionalOperator,@dValue,GETDATE(),NULL,null         
        
      FETCH NEXT FROM curTempRule INTO @uResultAttributeId,@iSubjectId,@vConditionalOperator,@dValue        
      END        
      Close curTempRule              
      DEALLOCATE curTempRule        
        FETCH NEXT FROM curTemp INTO @uTextSegmentId,@uTextKeywordId,@iOrder,@iStateId        
    END              
    Close curTemp              
    DEALLOCATE curTemp        
        
   FETCH NEXT FROM curTempFile INTO @uTextKeyWordId,@vKeyword,@uUserId        
 END              
 Close curTempFile              
 DEALLOCATE curTempFile        
        
 Select * from  t_TestDrive_Certificate WHERE iCertificateId = @iNewCertificateId and cIsDeleted='N' and uCertificateTemplateId=@uNewCertificateTemplateId        
END                   
END 

go
  
ALTER PROCEDURE Proc_TestDrive_StellwerkExternalDataSourceProvider_MapAndSaveMemberData                                            
(                                                  
    @MemberXml nvarchar(max),                
 @vMemberType nvarchar(500),                
 @uSchoolId uniqueidentifier,                
 @imainclientId int,                
 @ExtranetTeacherId nvarchar(max),                
 @iStateId int                
)                                                  
AS                                              
 /********************************************************************************************                                                                          
   Changed By: Sendil                                                                         
   Changed Date: 08.03.2016                
   Description: updates member information                 
 ********************************************************************************************/                                                                          
Begin                
 Declare @TempMemberId uniqueidentifier                
 Declare @DocHandle int                
                
 --set @MemberXml = replace(@MemberXml,'&','&amp;')                
                
 EXECUTE sp_xml_preparedocument @DocHandle OUTPUT,@MemberXml                
 if(@vMemberType = 'TEACHER')                
 Begin                
  if not exists(select * from t_TestDrive_Member_Teacher_ExternalSourceMapping where uTeacherExternalSourceId = @ExtranetTeacherId)                
  Begin                
   set @TempMemberId = newid()                
                
   insert into t_TestDrive_Member_Teacher(uTeacherId,uSchoolId,iTitleId,vFirstName,vName,vPhoneSchool,vPhonePrivate,vEmail,vPassword,dtCreatedOn,dtModifiedOn,vIPLastModifiedFrom ,                
    dtWhenLoginEmailSent,                 
    cIsDeleted ,iMainClientId ,vStreet ,vTown ,iZip ,vFunction ,uLastVisitedClassId                
    ,iProfilePictureFileSize ,iProfilePictureFileVersion ,vProfilePictureFileType                
    ,cIsTeacherCreatedByTeacher,uUserId,uTeacherCreatedById,iLanguageId,vAdministrationIP                
    ,vTestIP,vPasswordHash,vShortCut,cIsExternal)             
   SELECT @TempMemberId ,@uSchoolId ,iTitleId                
    ,vFirstName ,vName ,vPhoneSchool ,vPhonePrivate ,vEmail                
    ,vPassword ,GEtDate(), GETDATe(),        
    vIPLastModifiedFrom ,                
    GETDATE(),                 
    cIsDeleted ,@imainclientId ,vStreet ,vTown ,iZip ,vFunction ,uLastVisitedClassId                
    ,iProfilePictureFileSize ,iProfilePictureFileVersion ,vProfilePictureFileType                
    ,cIsTeacherCreatedByTeacher,uUserId,uTeacherCreatedById,iLanguageId,vAdministrationIP                
    ,vTestIP,vPasswordHash,'','Y'                 
   FROM OPENXML (@DocHandle, '/MemberData',1)                
   WITH                 
   (                
    uTeacherId uniqueidentifier 'uTeacherId'                
    ,uSchoolId nvarchar(max) 'uSchoolId'                
    ,iTitleId nvarchar(max) 'iTitleId'                
    ,vFirstName nvarchar(max) 'vFirstName'                
    ,vName nvarchar(max) 'vName'                
    ,vPhoneSchool nvarchar(max) 'vPhoneSchool'                
    ,vPhonePrivate nvarchar(max) 'vPhonePrivate'                
    ,vEmail nvarchar(max) 'vEmail'                
    ,vPassword nvarchar(max) 'vPassword'                
    --,dtCreatedOn datetime 'dtCreatedOn'                
    --,dtModifiedOn datetime 'dtModifiedOn'                
    ,vIPLastModifiedFrom nvarchar(max) 'vIPLastModifiedFrom'                
    --,dtWhenLoginEmailSent datetime 'dtWhenLoginEmailSent'                
    ,cIsDeleted nvarchar(max) 'cIsDeleted'                
    ,iMainClientId nvarchar(max) 'iMainClientId'                
    ,vStreet nvarchar(max) 'vStreet'                
    ,vTown nvarchar(max) 'vTown'                
    ,iZip nvarchar(max) 'iZip'           
    ,vFunction nvarchar(max) 'vFunction'                
    ,uLastVisitedClassId nvarchar(max) 'uLastVisitedClassId'         
    ,iProfilePictureFileSize nvarchar(max) 'iProfilePictureFileSize'                
    ,iProfilePictureFileVersion nvarchar(max) 'iProfilePictureFileVersion'                
    ,vProfilePictureFileType nvarchar(max) 'vProfilePictureFileType'                
    ,cIsTeacherCreatedByTeacher nvarchar(max) 'cIsTeacherCreatedByTeacher'                
    ,uUserId nvarchar(max) 'uUserId'                
    ,uTeacherCreatedById uniqueidentifier 'uTeacherCreatedById'                
    ,iLanguageId nvarchar(max) 'iLanguageId'                
    ,vAdministrationIP nvarchar(max) 'vAdministrationIP'                
    ,vTestIP nvarchar(max) 'vTestIP'                
    ,vPasswordHash nvarchar(max) 'vPasswordHash'                
   )                
   if exists(select uTeacherId from t_TestDrive_Member_Teacher where uTeacherId = @TempMemberId)                
   Begin                
    insert into t_TestDrive_Member_Teacher_ExternalSourceMapping(uTeacherId,iTeacherExternalSourceId,vFullName,iMainClientId,uSchoolId,vEmail,uTeacherExternalSourceIdGuid,uTeacherExternalSourceId,dtCreatedOn,dtModifiedOn,cIsDemoData) values (@TempMemberId
,null,null,@imainclientId,@uSchoolId,null,@ExtranetTeacherId,@ExtranetTeacherId,getdate(),getdate(),NULL)                
   end                
  End                
                  
  select @TempMemberId = uTeacherId from t_TestDrive_Member_Teacher_ExternalSourceMapping where uTeacherExternalSourceId = @ExtranetTeacherId                
                
                
  select *, iStateId, vSchoolName, '00000000-0000-0000-0000-000000000000' uClassId,'00000000-0000-0000-0000-000000000000' 'MainTeacherId',                
  'N' cIsTeacherCreatedByTeacher, tt.uTeacherId 'UserId'                
   from t_testdrive_member_teacher tt                 
  join t_TestDrive_Member_Teacher_ExternalSourceMapping tm on tm.uTeacherId = tt.uTeacherId                
  join t_testdrive_member_school ts on ts.uSchoolId = tt.uSchoolId                 
  where tt.uTeacherId = @TempMemberId                
                
  select * from t_TestDrive_Member_Teacher_ExternalSourceMapping where uTeacherId = @TempMemberId                
    
  if not exists(select * from t_TestDrive_Member_Teacher_School where uTeacherId = @TempMemberId and uSchoolId = @uSchoolId)     
   Begin    
       insert into t_TestDrive_Member_Teacher_School(uTeacherSchoolId,uSchoolId,uTeacherId,cIsAdmin,cIsDeleted) values    
    (NEWID(),@uSchoolId,@TempMemberId,'N','N')    
   End      
  Else    
   Begin    
          update t_TestDrive_Member_Teacher_School set cIsDeleted = 'N' WHERE uTeacherId = @TempMemberId and uSchoolId = @uSchoolId    
   End    
                 
 End                
 if(@vMemberType = 'SCHOOL')                
 Begin                
   if not exists(select * from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = cast(@uSchoolId as nvarchar(36)))                
   Begin                
    set @TempMemberId = newid()                
                
    insert into t_TestDrive_Member_School(uSchoolId                
      ,vSchoolName                
      ,iStateId                
      ,iTitleId                
      ,vFirstName                
      ,vName                
      ,vStreet                
      ,iZIPCode                
      ,vTown                
      ,vPhone                
      ,vEmail                
      ,vPassword                
      ,dtCreatedOn              
      ,dtModifiedOn      
      ,vIPLastModifiedFrom                
      ,dtWhenLoginlEmailSent                 
      ,cIsDeleted                
      ,iMainClientId                
      ,iLanguageId                
      ,cIsTestSchool                
      ,iSchoolTypeId                
      ,cHasLearnCoacher                
      ,iProfilePictureFileSize                
      ,iProfilePictureFileVersion                
      ,vProfilePictureFileType                
      ,vPhonePrivate                
      ,uUserId                
      ,vAdministrationIP                
      ,vTestIP            
      ,vPasswordHash                
      ,uLastVisitedTeacherId        
   ,cIsExternal)               
    SELECT @TempMemberId                
      ,vSchoolName                
      ,@iStateId                
      ,iTitleId                
      ,vFirstName                
      ,vName                
      ,vStreet                
      ,iZIPCode                
      ,vTown                
      ,vPhone                
      ,vEmail                
      ,vPassword                
      ,GetDAte() --CASE  WHEN dtCreatedOn= '' THEN null WHEN dtCreatedOn< > '' THEN convert(datetime,dtCreatedOn,104) END                
      ,GetDAte() --CASE  WHEN dtModifiedOn= '' THEN null WHEN dtModifiedOn< > '' THEN convert(datetime,dtModifiedOn,104) END                
      ,vIPLastModifiedFrom                
      ,GetDAte() --CASE  WHEN dtWhenLoginlEmailSent= '' THEN null WHEN dtWhenLoginlEmailSent< > '' THEN convert(datetime,dtWhenLoginlEmailSent,104) END                 
      ,cIsDeleted                
      ,@imainclientId                
      ,iLanguageId                
      ,cIsTestSchool              
      ,iSchoolTypeId                
      ,cHasLearnCoacher                
      ,iProfilePictureFileSize                
      ,iProfilePictureFileVersion                
      ,vProfilePictureFileType                
      ,vPhonePrivate                
      ,uUserId                
      ,vAdministrationIP                
      ,vTestIP                
      ,vPasswordHash                
      ,uLastVisitedTeacherId        
   ,'Y'               
      FROM OPENXML (@DocHandle, '/MemberData',1)                
    WITH                 
    (                
       uSchoolId uniqueidentifier 'uSchoolId'                
      ,vSchoolName nvarchar(max) 'vSchoolName'                
      ,iStateId nvarchar(max) 'iStateId'                
      ,iTitleId nvarchar(max) 'iTitleId'                
      ,vFirstName nvarchar(max) 'vFirstName'                
      ,vName nvarchar(max) 'vName'                
      ,vStreet nvarchar(max) 'vStreet'                
      ,iZIPCode nvarchar(max) 'iZIPCode'                
      ,vTown nvarchar(max) 'vTown'                
      ,vPhone nvarchar(max) 'vPhone'                
      ,vEmail nvarchar(max) 'vEmail'                
      ,vPassword nvarchar(max) 'vPassword'                
      --,dtCreatedOn datetime 'dtCreatedOn'                
      --,dtModifiedOn datetime 'dtModifiedOn'                
      ,vIPLastModifiedFrom nvarchar(max) 'vIPLastModifiedFrom'                
      --,dtWhenLoginlEmailSent nvarchar(max) 'dtWhenLoginlEmailSent'                
      ,cIsDeleted nvarchar(max) 'cIsDeleted'                
      ,iMainClientId nvarchar(max) 'iMainClientId'                
      ,iLanguageId nvarchar(max) 'iLanguageId'                
      ,cIsTestSchool nvarchar(max) 'cIsTestSchool'                
      ,iSchoolTypeId nvarchar(max) 'iSchoolTypeId'                
      ,cHasLearnCoacher nvarchar(max) 'cHasLearnCoacher'                
      ,iProfilePictureFileSize nvarchar(max) 'iProfilePictureFileSize'                
      ,iProfilePictureFileVersion nvarchar(max) 'iProfilePictureFileVersion'                
      ,vProfilePictureFileType nvarchar(max) 'vProfilePictureFileType'                
      ,vPhonePrivate nvarchar(max) 'vPhonePrivate'                
      ,uUserId nvarchar(max) 'uSchoolId'                
      ,vAdministrationIP nvarchar(max) 'vAdministrationIP'                
      ,vTestIP nvarchar(max) 'vTestIP'                
      ,vPasswordHash nvarchar(max) 'vPasswordHash'                
      ,uLastVisitedTeacherId uniqueidentifier 'uLastVisitedTeacherId'                
    )                
    if exists(select uschoolid from t_TestDrive_Member_School where uSchoolId = @TempMemberId)                
    begin                
     insert into t_TestDrive_Member_school_ExternalSourceMapping values (@TempMemberId, @uSchoolId, @imainclientId,@uSchoolId,GETDATE(),getdate(),null)                    end                
   End                
   select @TempMemberId = uSchoolId from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = cast(@uSchoolId as nvarchar(36))                
                
   select * from t_TestDrive_Member_School where uSchoolId = @TempMemberId                
   select * from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolId = @TempMemberId                
 End                
 if(@vMemberType = 'STATE')                
 Begin                
                  
  if not exists(select * from t_TestDrive_Member_State_ExternalSourceMapping where iStateExternalSourceId = @iStateId)                
  Begin                
   Declare @tempStateId int                
                   
                
   insert into t_TestDrive_Member_State (iDisplayOrder,iMainClientId,iStateNumberForTestToken,cHasLearnCoacher,vLogoFileName,  
   iLogoSize,iLogoFileVersion,vLogoFileType,iTitleId,vFirstName,vName,vLongName,cIsUsedForDemoTestActivityRecording,cIsDeleted,dtModifiedOn,dtCreatedOn,uUserId)               
   SELECT iDisplayOrder                
     ,@imainclientId                
     ,iStateNumberForTestToken                
     ,cHasLearnCoacher                
     ,vLogoFileName                
     ,iLogoSize                
     ,iLogoFileVersion                
     ,vLogoFileType                
     ,iTitleId                
     ,vFirstName                
     ,vName                
     ,vLongName,cIsUsedForDemoTestActivityRecording,'N',GETDATE(),GETDATE(),null                
    FROM OPENXML (@DocHandle, '/MemberData',1)                
    WITH                 
    (                
     iDisplayOrder nvarchar(max) 'iDisplayOrder'                
     ,iMainClientId nvarchar(max) 'iMainClientId'                
     ,iStateNumberForTestToken nvarchar(max) 'iStateNumberForTestToken'                
     ,cHasLearnCoacher nvarchar(max) 'cHasLearnCoacher'                
     ,vLogoFileName nvarchar(max) 'vLogoFileName'                
     ,iLogoSize nvarchar(max) 'iLogoSize'                
     ,iLogoFileVersion nvarchar(max) 'iLogoFileVersion'                
     ,vLogoFileType nvarchar(max) 'vLogoFileType'                
     ,iTitleId nvarchar(max) 'iTitleId'                
     ,vFirstName nvarchar(max) 'vFirstName'                
     ,vName nvarchar(max) 'vName'                
     ,vLongName nvarchar(max) 'vLongName'                
     ,cIsUsedForDemoTestActivityRecording nvarchar(max) 'cIsUsedForDemoTestActivityRecording'                     
    )                
   set @tempStateId = @@IDENTITY                
                
   if exists (select istateId from t_TestDrive_Member_State where iStateId = @tempStateId)                
   Begin                
    insert into t_TestDrive_Member_State_ExternalSourceMapping values (@tempStateId, @iStateId, @imainclientId)                
                
    insert into t_TestDrive_Member_State_Data                
    select @tempStateId                
       ,iLanguageId                
       ,vShortStateName                
       ,vStateName                
       FROM OPENXML (@DocHandle, '/MemberData/',1)                
     WITH                 
     (                 
       iStateId nvarchar(max) 'iStateId'                
,iLanguageId nvarchar(max) 'iLanguageId'                
      ,vShortStateName nvarchar(max) 'vShortStateName'                
      ,vStateName nvarchar(max) 'vStateName'                
     )                
   end                
  End                
  select @tempStateId = iStateId from t_TestDrive_Member_State_ExternalSourceMapping where iStateExternalSourceId = @iStateId                
                
  select * from t_TestDrive_Member_State where iStateId = @tempStateId                
  select * from t_TestDrive_Member_State_ExternalSourceMapping where iStateId = @tempStateId                
 End                
 EXEC sp_xml_removedocument @DocHandle                
End   
GO
ALTER PROC [dbo].[JProc_LearnCoacher_News_ForwardNews]                
(          
 @iMainClientId int,            
 @uFromId uniqueidentifier,                                                          
 @uClassId uniqueidentifier,                                               
 @cIsPupil char(1),                                
 @cIsTeacher char(1),                                
 @cIsDeleted char(1),                                 
 @uPupilIds nvarchar(max),                
 @NewsIds nvarchar(max)                                 
)                                
as                                 
begin                    
DECLARE @tempNewsIds TABLE (uNewsId uniqueidentifier)                  
                
DECLARE @vText nvarchar(4000)      
declare @uNewsId uniqueidentifier            
declare @uNewNewsId uniqueidentifier            
declare @uOriginalNewsItemId uniqueidentifier                
declare cursor_SaveData Cursor For                                                                  
Select * from OPENJSON(@NewsIds) with(uNewsId uniqueidentifier '$.uNewsId')                                          
open cursor_SaveData                                                                 
Fetch Next from cursor_SaveData into @uNewsId                                   
 while(@@FETCH_STATUS <> -1)                                                             
 Begin               
           
  if(EXISTS(select uOriginalNewsItemId from t_LearnCoacher_News where uNewsId=@uNewsId  AND uOriginalNewsItemId IS NOT NULL))            
  begin            
   select @uOriginalNewsItemId=uOriginalNewsItemId, @vText = vText from t_LearnCoacher_News where uNewsId=@uNewsId      
  end            
  else            
  begin      
   select @uOriginalNewsItemId=uNewsId, @vText = vText from t_LearnCoacher_News where uNewsId=@uNewsId       
  end            
        
                
                
  declare @uUserId uniqueidentifier                
  declare @IsGroup char                
  declare mycursor Cursor For                                                                  
  Select * from OPENJSON(@uPupilIds)                                                                                
  with(uUserId uniqueidentifier '$.uUserId',IsGroup char '$.IsGroup')                                          
  open mycursor                                                                 
  Fetch Next from mycursor into @uUserId,@IsGroup                                   
   while(@@FETCH_STATUS <> -1)                                                             
   Begin        
    SET @uNewNewsId=NEWID()           
    INSERT INTO t_LearnCoacher_News       
    VALUES (@uNewNewsId,@iMainClientId,@uClassId,@uFromId,@cIsPupil,@cIsTeacher,@vText,GETDATE(),GETDATE(),@cIsDeleted,@uOriginalNewsItemId,@uNewsId,NULL,NULL)            
    IF (EXISTS(select * from t_LearnCoacher_News_Attachment where uNewsId = @uOriginalNewsItemId))      
    BEGIN      
     INSERT INTO t_LearnCoacher_News_Attachment       
     SELECT       
     NEWID(),@uNewNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId,Null,Null,Null       
     FROM t_LearnCoacher_News_Attachment       
     WHERE uNewsId = @uOriginalNewsItemId      
    END      
    INSERT INTO @tempNewsIds VALUES(@uNewNewsId)        
                 
    if(@IsGroup = 'Y')                
    begin                   
     DECLARE @MyCursor CURSOR;                
     DECLARE @MyField uniqueidentifier;                
     BEGIN                
     SET @MyCursor = CURSOR FOR                
     select uUserId from t_LearnCoacher_News_Group_User where uNewsGroupId=@uUserId                
                
     OPEN @MyCursor                 
     FETCH NEXT FROM @MyCursor                 
     INTO @MyField                
                
     WHILE @@FETCH_STATUS = 0                
     BEGIN                      
      insert into t_LearnCoacher_News_ToUser values(newid(),@uNewNewsId,@MyField,'Y','N','Y',@uUserId,'N','N',NULL)         
     FETCH NEXT FROM @MyCursor                 
     INTO @MyField                 
     END;                 
                
     CLOSE @MyCursor ;                
     DEALLOCATE @MyCursor;                
     END                
    end                
    else                
    begin                
     insert into t_LearnCoacher_News_ToUser values(newid(),@uNewNewsId,@uUserId,'Y','N','N','00000000-0000-0000-0000-000000000000','N','N',NULL)                
    end                   
   Fetch Next from mycursor into @uUserId,@IsGroup                                
   End                            
  Close mycursor                                                          
  Deallocate mycursor                          
  Fetch Next from cursor_SaveData into @uNewsId                               
 End                      
Close cursor_SaveData                                                          
Deallocate cursor_SaveData                 
                
                    
                      
                      
select( select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsSchool,cIsTeacher,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                       
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News                      
where uClassId = @uClassId and cIsDeleted = 'N' and uNewsId in(select uNewsId from @tempNewsIds) order by dtCreatedOn                      
                      
select (select uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted                       
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                      
on TU.uNewsId = N.uNewsId and TU.cIsDeleted = 'N' and N.uNewsId in(select uNewsId from @tempNewsIds) where N.uClassId = @uClassId                      
                      
select (select uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId                      
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                      
on NA.uNewsId = N.uNewsId where N.uClassId = @uClassId and N.cIsDeleted = 'N' and N.uNewsId in(select uNewsId from @tempNewsIds)                            
                              
end

GO

ALTER PROC [dbo].[JProc_LearnCoacher_ForwardNews]              
(        
 @iMainClientId int,          
 @uFromId uniqueidentifier,                                                        
 @uClassId uniqueidentifier,                                             
 @cIsPupil char(1),                              
 @cIsTeacher char(1),                              
 @cIsDeleted char(1),                               
 @uPupilIds nvarchar(max),              
 @NewsIds nvarchar(max)                               
)                              
as                               
begin        
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/          
DECLARE @tempNewsIds TABLE (uNewsId uniqueidentifier)                
              
DECLARE @vText nvarchar(4000)    
declare @uNewsId uniqueidentifier          
declare @uNewNewsId uniqueidentifier          
declare @uOriginalNewsItemId uniqueidentifier              
declare cursor_SaveData Cursor For                                                                
Select * from OPENJSON(@NewsIds) with(uNewsId uniqueidentifier '$.uNewsId')                                        
open cursor_SaveData                                                               
Fetch Next from cursor_SaveData into @uNewsId                                 
 while(@@FETCH_STATUS <> -1)                                                           
 Begin             
         
  if(EXISTS(select uOriginalNewsItemId from t_LearnCoacher_News where uNewsId=@uNewsId  AND uOriginalNewsItemId IS NOT NULL))          
  begin          
   select @uOriginalNewsItemId=uOriginalNewsItemId, @vText = vText from t_LearnCoacher_News where uNewsId=@uNewsId    
  end          
  else          
  begin    
   select @uOriginalNewsItemId=uNewsId, @vText = vText from t_LearnCoacher_News where uNewsId=@uNewsId     
  end          
      
              
              
  declare @uUserId uniqueidentifier              
  declare @IsGroup char              
  declare mycursor Cursor For                                                                
  Select * from OPENJSON(@uPupilIds)                                                                              
  with(uUserId uniqueidentifier '$.uUserId',IsGroup char '$.IsGroup')                                        
  open mycursor                                                               
  Fetch Next from mycursor into @uUserId,@IsGroup                                 
   while(@@FETCH_STATUS <> -1)                                                           
   Begin      
    SET @uNewNewsId=NEWID()         
    INSERT INTO t_LearnCoacher_News   (uNewsId,	iMainClientId,	uClassId,	uUserId,	cIsPupil,	cIsTeacher,	vText,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	uOriginalNewsItemId,	uParentNewsItemId,	cIsSchool)  
    VALUES (@uNewNewsId,@iMainClientId,@uClassId,@uFromId,@cIsPupil,@cIsTeacher,@vText,GETDATE(),GETDATE(),@cIsDeleted,@uOriginalNewsItemId,@uNewsId, NULL)          
    IF (EXISTS(select * from t_LearnCoacher_News_Attachment where uNewsId = @uOriginalNewsItemId))    
    BEGIN    
     INSERT INTO t_LearnCoacher_News_Attachment  (uNewsAttachmentId,	uNewsId,	vAttachmentFileName,	iFileSizeInBytes,	vFileType,	iDisplayOrder,	vFileId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)   
     SELECT     
     NEWID(),@uNewNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId,Null,null,null     
     FROM t_LearnCoacher_News_Attachment     
     WHERE uNewsId = @uOriginalNewsItemId    
    END    
    INSERT INTO @tempNewsIds VALUES(@uNewNewsId)      
               
    if(@IsGroup = 'Y')              
    begin                 
     DECLARE @MyCursor CURSOR;              
     DECLARE @MyField uniqueidentifier;              
     BEGIN              
     SET @MyCursor = CURSOR FOR              
     select uUserId from t_LearnCoacher_News_Group_User where uNewsGroupId=@uUserId              
              
     OPEN @MyCursor               
     FETCH NEXT FROM @MyCursor               
     INTO @MyField              
              
     WHILE @@FETCH_STATUS = 0              
     BEGIN                    
      insert into t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
	  values(newid(),@uNewNewsId,@MyField,'Y','N','Y',@uUserId,'N','N')              
     FETCH NEXT FROM @MyCursor               
     INTO @MyField               
     END;               
              
     CLOSE @MyCursor ;           
     DEALLOCATE @MyCursor;              
     END              
    end              
    else              
    begin              
     insert into t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
	  values(newid(),@uNewNewsId,@uUserId,'Y','N','N','00000000-0000-0000-0000-000000000000','N','N')              
    end                 
   Fetch Next from mycursor into @uUserId,@IsGroup                              
   End                          
  Close mycursor                                                        
  Deallocate mycursor                        
  Fetch Next from cursor_SaveData into @uNewsId                             
 End                    
Close cursor_SaveData                                                        
Deallocate cursor_SaveData               
              
                  
                    
                    
select( select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                     
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News                    
where uClassId = @uClassId and cIsDeleted = 'N' and uNewsId in(select uNewsId from @tempNewsIds) order by dtCreatedOn                    
                    
select (select uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted                     
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                    
on TU.uNewsId = N.uNewsId and TU.cIsDeleted = 'N' and N.uNewsId in(select uNewsId from @tempNewsIds) where N.uClassId = @uClassId                    
                    
select (select uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId                    
for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                    
on NA.uNewsId = N.uNewsId where N.uClassId = @uClassId and N.cIsDeleted = 'N' and N.uNewsId in(select uNewsId from @tempNewsIds)                          
                            
end 

go
ALTER PROC [dbo].[JProc_LearnCoacher_News_ForwardNews_20_02_2019]    
(            
 @iMainClientId int,              
 @uFROMId uniqueidentifier,                                                            
 @uClassId uniqueidentifier,                                                 
 @cIsPupil char(1),                                  
 @cIsTeacher char(1),                                  
 @cIsDeleted char(1),                                   
 @uPupilIds nvarchar(max),                  
 @NewsIds nvarchar(max)                                   
)                                  
AS                                   
BEGIN 
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/       
   
 DECLARE @tempNewsIds TABLE (uNewsId uniqueidentifier)                  
 DECLARE @vText nvarchar(4000)        
 DECLARE @uNewsId uniqueidentifier              
 DECLARE @uNewNewsId uniqueidentifier              
 DECLARE @uOriginalNewsItemId uniqueidentifier                  
 DECLARE cursor_SaveData CURSOR FOR                                                                    
  SELECT    
   *     
  FROM OPENJSON(@NewsIds) WITH(uNewsId uniqueidentifier '$.uNewsId')                                            
 OPEN cursor_SaveData                                                                   
 FETCH NEXT FROM  cursor_SaveData INTO @uNewsId                                     
  WHILE(@@FETCH_STATUS <> -1)                                                      
  BEGIN             
   IF(EXISTS(SELECT uOriginalNewsItemId FROM t_LearnCoacher_News WHERE uNewsId=@uNewsId  AND uOriginalNewsItemId IS NOT NULL))              
    BEGIN              
     SELECT     
      @uOriginalNewsItemId=uOriginalNewsItemId,    
      @vText = vText     
     FROM     
      t_LearnCoacher_News     
     WHERE uNewsId=@uNewsId        
    END              
   ELSE              
    BEGIN        
     SELECT     
      @uOriginalNewsItemId=uNewsId, @vText = vText     
     FROM     
      t_LearnCoacher_News     
     WHERE uNewsId=@uNewsId         
    END    
                      
   DECLARE @uUserId uniqueidentifier                  
   DECLARE @IsGroup char, @IsTeacher char, @IsPupil char                  
   DECLARE mycursor Cursor For                                                                    
    SELECT * FROM OPENJSON(@uPupilIds)                                                                                  
    WITH(uUserId uniqueidentifier '$.uUserId',IsGroup char '$.IsGroup',IsTeacher char '$.IsTeacher',IsPupil char '$.IsPupil')    
                                                
   OPEN mycursor                                                                   
   FETCH NEXT FROM  mycursor INTO @uUserId,@IsGroup,@IsTeacher,@IsPupil                                     
   WHILE(@@FETCH_STATUS <> -1)                                                               
    BEGIN          
     SET @uNewNewsId=NEWID()             
     INSERT INTO t_LearnCoacher_News (uNewsId,	iMainClientId,	uClassId,	uUserId,	cIsPupil,	cIsTeacher,	vText,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	uOriginalNewsItemId,	uParentNewsItemId,	cIsSchool)        
     VALUES (@uNewNewsId,@iMainClientId,@uClassId,@uFROMId,@cIsPupil,@cIsTeacher,    
       @vText,GETDATE(),GETDATE(),@cIsDeleted,@uOriginalNewsItemId,@uNewsId,NULL)      
                   
     IF (EXISTS(SELECT * FROM t_LearnCoacher_News_Attachment WHERE uNewsId = @uOriginalNewsItemId))        
      BEGIN        
       INSERT INTO     
        t_LearnCoacher_News_Attachment  (uNewsAttachmentId,	uNewsId,	vAttachmentFileName,	iFileSizeInBytes,	vFileType,	iDisplayOrder,	vFileId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)    
       SELECT         
        NEWID(),@uNewNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId,null,null,null         
       FROM     
        t_LearnCoacher_News_Attachment         
       WHERE     
        uNewsId = @uOriginalNewsItemId        
      END        
         
     INSERT INTO @tempNewsIds VALUES(@uNewNewsId)          
                   
     IF(@IsGroup = 'Y')    
      BEGIN     
       DECLARE @MyCursor CURSOR;                  
       DECLARE @MyField uniqueidentifier;             
           
       SET @MyCursor = CURSOR FOR                  
       SELECT uUserId FROM t_LearnCoacher_News_Group_User WHERE uNewsGroupId=@uUserId                  
                  
       OPEN @MyCursor                   
       FETCH NEXT FROM  @MyCursor                   
       INTO @MyField                  
                  
       WHILE @@FETCH_STATUS = 0                  
        BEGIN                        
         INSERT INTO     
          t_LearnCoacher_News_ToUser(uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)   
         VALUES    
          (NEWID(),@uNewNewsId,@MyField,@IsPupil,@IsTeacher,@IsGroup,@uUserId,'N','N')                  
         FETCH NEXT FROM  @MyCursor                   
         INTO @MyField                   
        END;                   
                  
       CLOSE @MyCursor ;                  
       DEALLOCATE @MyCursor;                  
      END                  
     ELSE                  
      BEGIN                  
       INSERT INTO     
        t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)   
       VALUES    
        (NEWID(),@uNewNewsId,@uUserId,@IsPupil,@IsTeacher,@IsGroup,'00000000-0000-0000-0000-000000000000','N','N')                  
      END    
                           
     FETCH NEXT FROM  mycursor INTO @uUserId,@IsGroup,@IsTeacher,@IsPupil    
    END       
   CLOSE mycursor                                                            
   DEALLOCATE mycursor                            
   FETCH NEXT FROM  cursor_SaveData INTO @uNewsId                                 
  END                        
     
     
 Close cursor_SaveData                                                            
 Deallocate cursor_SaveData                   
                  
                      
                        
                        
 SELECT( SELECT uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsSchool,cIsTeacher,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                         
 for json path,include_null_VALUES,without_array_wrapper) as JSONResult FROM t_LearnCoacher_News                        
 WHERE uClassId = @uClassId and cIsDeleted = 'N' and uNewsId in(SELECT uNewsId FROM @tempNewsIds) order by dtCreatedOn                        
                        
 SELECT (SELECT uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted                         
 for json path,include_null_VALUES,without_array_wrapper) as JSONResult FROM t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                        
 on TU.uNewsId = N.uNewsId and TU.cIsDeleted = 'N' and N.uNewsId in(SELECT uNewsId FROM @tempNewsIds) WHERE N.uClassId = @uClassId                        
                        
 SELECT (SELECT uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId                        
 for json path,include_null_VALUES,without_array_wrapper) as JSONResult FROM t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                        
 on NA.uNewsId = N.uNewsId WHERE N.uClassId = @uClassId and N.cIsDeleted = 'N' and N.uNewsId in(SELECT uNewsId FROM @tempNewsIds)      
                                
END 

Go

ALTER PROC [dbo].[JProc_LearnCoacher_News_SaveNews](                                        
 @uNewsId uniqueidentifier,                                        
 @iMainClientId int,                                        
 @uClassId uniqueidentifier,       
 @uSchoolId uniqueidentifier,                       
 @uFromId uniqueidentifier,                                        
 @uToId uniqueidentifier,                                        
 @vText varchar(8000),                                        
 @cIsPupil char(1),                                        
 @cIsTeacher char(1),          
 @cIsSchool  char(1),                                    
 @cIsDeleted char(1),                                        
 @cIsToPupil char(1),                                        
 @cIsToTeacher char(1),                                        
 @cIsForGroup char(1),                                        
 @uGroupId uniqueidentifier,                                    
 @vFileJson nvarchar(max) = ''                                        
)                                        
as                                         
begin   
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/                                      
  create table #tempRecords(uNewsAttachmentId uniqueidentifier)                                       
 if(@uNewsId = '00000000-0000-0000-0000-000000000000')                                        
 begin                                        
 set @uNewsId = NEWID();                           
                                     
 insert into t_LearnCoacher_News (uNewsId,	iMainClientId,	uClassId,	uUserId,	cIsPupil,	cIsTeacher,	vText,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	uOriginalNewsItemId,	uParentNewsItemId,	cIsSchool)      
 values(@uNewsId,@iMainClientId,@uClassId,@uFromId,@cIsPupil,@cIsTeacher,@vText,GETDATE(),GETDATE(),@cIsDeleted,null,null,@cIsSchool)      
          
 IF(@cIsSchool = 'Y')      
  BEGIN      
   INSERT INTO t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)      
   VALUES (NEWID(),@uNewsId,'00000000-0000-0000-0000-000000000000',@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N','N')      
   --DECLARE @Temp int      
  END      
 ELSE      
  BEGIN      
   if(@cIsForGroup = 'Y')                          
    begin                          
     create table #tempGroupRecords(uUserId uniqueidentifier,cIsPupil char,cIsTeacher char)                           
     insert into #tempGroupRecords(uUserId,cIsPupil,cIsTeacher)       
     select uUserId,cIsPupil,cIsTeacher       
     from t_LearnCoacher_News_Group_User       
     where uNewsGroupId=@uGroupId                          
                          
     DECLARE @MyCursor CURSOR;                          
     DECLARE @userid uniqueidentifier;                    
     DECLARE @cIsPupilGroupUser char;                    
     DECLARE @cIsTeacherGroupUser char;                          
     BEGIN                          
      SET @MyCursor = CURSOR FOR                          
      select  uUserId,cIsPupil,cIsTeacher from #tempGroupRecords                          
      OPEN @MyCursor                           
       FETCH NEXT FROM @MyCursor                           
       INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                          
       WHILE @@FETCH_STATUS = 0                          
        BEGIN                    
         DECLARE @cHasBeenViewed char;                    
         if(@userid = @uFromId)                    
          BEGIN                    
           SET @cHasBeenViewed='Y';                    
          END                    
         ELSE           
          BEGIN                    
           SET @cHasBeenViewed='N';                    
          END      
                                   
         insert into t_LearnCoacher_News_ToUser    (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)   
         values(NEWID(),@uNewsId,@userid,@cIsPupilGroupUser,@cIsTeacherGroupUser,@cIsForGroup,@uGroupId,@cHasBeenViewed,@cIsDeleted)                           
                          
         FETCH NEXT FROM @MyCursor                           
         INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                           
        END;                          
      CLOSE @MyCursor ;         
      DEALLOCATE @MyCursor;                          
     END;                          
    END                          
   ELSE                          
    BEGIN                          
     INSERT INTO t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
	 values(NEWID(),@uNewsId,@uToId,@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N',@cIsDeleted)                              
    END             
  END                    
       
                                      
  declare @ClientFileName nvarchar(500)                                     
  declare @vFileType nvarchar(10)                                     
  declare @vFileSize int                                         
  declare cursor_SaveData Cursor For                                                                          
    Select * from OPENJSON(@vFileJson)                     
    with(ClientFileName nvarchar(500) '$.ClientFileName',FileType nvarchar(10) '$.FileType',FileSize int '$.FileSize')                                 
 open cursor_SaveData                                                                         
 Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                              
    while(@@FETCH_STATUS <> -1)                                  
    Begin                                     
   declare @uNewsAttachmentId uniqueidentifier                                    
   set @uNewsAttachmentId= NEWID();                       
   insert into t_LearnCoacher_News_Attachment (uNewsAttachmentId,	uNewsId,	vAttachmentFileName,	iFileSizeInBytes,	vFileType,	iDisplayOrder,	vFileId,	cIsFromOldOneDrive)  
  values(@uNewsAttachmentId,@uNewsId,@ClientFileName,(@vFileSize*1024),@vFileType,1,null,null)                                     
   insert into #tempRecords (uNewsAttachmentId)values(@uNewsAttachmentId)                                     
   Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                        
    End                                    
    Close cursor_SaveData                                                                  
    Deallocate cursor_SaveData                                     
 --select (select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,vText,dtCreatedOn,cIsDeleted for json path,include_null_values,without_array_wrapper)       
 --as JSONResult from t_LearnCoacher_News where uNewsId=@uNewsId      
 end                                        
                              
  select( select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,cIsSchool,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                               
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News                              
  where uNewsId=@uNewsId order by dtCreatedOn                              
                              
  select (select uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted          
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                              
  on TU.uNewsId = N.uNewsId where N.uNewsId=@uNewsId                              
                              
  select (select uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId                              
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                              
  on NA.uNewsId = N.uNewsId where N.uNewsId=@uNewsId                                     
                                      
end 

Go

---------------------------------------------------------------------------------------
ALTER PROC [dbo].[JProc_LearnCoacher_News_SaveNews_25_03_2019]    
(                                          
 @uNewsId uniqueidentifier,                                          
 @iMainClientId int,                                          
 @uClassId uniqueidentifier,         
 @uSchoolId uniqueidentifier,                         
 @uFromId uniqueidentifier,                                          
 @uToId uniqueidentifier,                                          
 @vText varchar(8000),                                          
 @cIsPupil char(1),                                          
 @cIsTeacher char(1),            
 @cIsSchool  char(1),                                      
 @cIsDeleted char(1),                                          
 @cIsToPupil char(1),                                          
 @cIsToTeacher char(1),                                          
 @cIsForGroup char(1),                                          
 @uGroupId uniqueidentifier,                                      
 @vFileJson nvarchar(max) = ''                                          
)                                          
as                                           
begin  
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/                                         
  create table #tempRecords(uNewsAttachmentId uniqueidentifier)                                         
 if(@uNewsId = '00000000-0000-0000-0000-000000000000')                                          
 begin                                          
 set @uNewsId = NEWID();                             
                                       
 insert into t_LearnCoacher_News  (uNewsId,	iMainClientId,	uClassId,	uUserId,	cIsPupil,	cIsTeacher,	vText,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	uOriginalNewsItemId,	uParentNewsItemId,	cIsSchool)
       
 values(@uNewsId,@iMainClientId,@uClassId,@uFromId,@cIsPupil,@cIsTeacher,@vText,GETDATE(),GETDATE(),@cIsDeleted,null,null,@cIsSchool)        
            
 IF(@cIsSchool = 'Y')        
  BEGIN        
   INSERT INTO t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
        
   VALUES (NEWID(),@uNewsId,'00000000-0000-0000-0000-000000000000',@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N','N')        
  END        
 -- BEGIN    
 --IF(@cIsToPupil='Y')    
 -- BEGIN    
 --  INSERT INTO t_LearnCoacher_News_ToUser          
 --  SELECT NEWID(),@uNewsId,uPupilId,@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N',@cIsDeleted FROM     
 --  t_TestDrive_Member_Class_Pupil    
 --  WHERE uClassId = @uClassId and cIsDeleted = 'N' AND cIsArchive = 'N'    
 -- END    
 --ELSE    
 -- BEGIN    
 --  INSERT INTO t_LearnCoacher_News_ToUser          
 --  SELECT NEWID(),@uNewsId,uTeacherId,@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N',@cIsDeleted FROM     
 --  t_TestDrive_Member_Teacher_School    
 --  WHERE uSchoolId = @uSchoolId and cIsDeleted = 'N'    
 -- END    
 --END    
 ELSE        
  BEGIN        
   if(@cIsForGroup = 'Y')                            
    begin                            
     create table #tempGroupRecords(uUserId uniqueidentifier,cIsPupil char,cIsTeacher char)                             
     insert into #tempGroupRecords(uUserId,cIsPupil,cIsTeacher)         
     select uUserId,cIsPupil,cIsTeacher         
     from t_LearnCoacher_News_Group_User         
     where uNewsGroupId=@uGroupId                            
                            
     DECLARE @MyCursor CURSOR;                            
     DECLARE @userid uniqueidentifier;                      
     DECLARE @cIsPupilGroupUser char;                      
     DECLARE @cIsTeacherGroupUser char;                          
     BEGIN                            
      SET @MyCursor = CURSOR FOR                            
      select  uUserId,cIsPupil,cIsTeacher from #tempGroupRecords                            
      OPEN @MyCursor                             
       FETCH NEXT FROM @MyCursor                             
       INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                            
       WHILE @@FETCH_STATUS = 0                            
        BEGIN                      
         DECLARE @cHasBeenViewed char;                      
         if(@userid = @uFromId)                      
          BEGIN                      
           SET @cHasBeenViewed='Y';                      
          END                      
         ELSE                      
          BEGIN                      
           SET @cHasBeenViewed='N';                      
          END        
                                     
         insert into t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)        
         values(NEWID(),@uNewsId,@userid,@cIsPupilGroupUser,@cIsTeacherGroupUser,@cIsForGroup,@uGroupId,@cHasBeenViewed,@cIsDeleted)                             
                            
         FETCH NEXT FROM @MyCursor                             
         INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                             
        END;                            
      CLOSE @MyCursor ;                            
      DEALLOCATE @MyCursor;                            
     END;                            
    END                            
   ELSE                            
    BEGIN    
  INSERT INTO t_LearnCoacher_News_ToUser   (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)  
  values(NEWID(),@uNewsId,@uToId,@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N',@cIsDeleted)                                
    END               
  END                                        
  declare @ClientFileName nvarchar(500)                                       
  declare @vFileType nvarchar(10)                                       
  declare @vFileSize int                                           
  declare cursor_SaveData Cursor For                                                                            
    Select * from OPENJSON(@vFileJson)                       
    with(ClientFileName nvarchar(500) '$.ClientFileName',FileType nvarchar(10) '$.FileType',FileSize int '$.FileSize')                                   
 open cursor_SaveData                                                                           
 Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                                
    while(@@FETCH_STATUS <> -1)                                    
    Begin                                       
   declare @uNewsAttachmentId uniqueidentifier                                      
   set @uNewsAttachmentId= NEWID();                         
   insert into t_LearnCoacher_News_Attachment (uNewsAttachmentId,	uNewsId,	vAttachmentFileName,	iFileSizeInBytes,	vFileType,	iDisplayOrder,	vFileId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)  
   values(@uNewsAttachmentId,@uNewsId,@ClientFileName,(@vFileSize*1024),@vFileType,1,null,null,null,null)                                       
   insert into #tempRecords (uNewsAttachmentId)values(@uNewsAttachmentId)                                       
   Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                          
    End                                      
    Close cursor_SaveData                                                                    
    Deallocate cursor_SaveData                                       
 --select (select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,vText,dtCreatedOn,cIsDeleted for json path,include_null_values,without_array_wrapper)         
 --as JSONResult from t_LearnCoacher_News where uNewsId=@uNewsId        
 end                                          
                                
  select( select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,cIsSchool,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                                 
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News                                
  where uNewsId=@uNewsId order by dtCreatedOn                                
                                
  select (select uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted                                 
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                                
  on TU.uNewsId = N.uNewsId where N.uNewsId=@uNewsId                                
                                
  select (select uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId                                
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                                
  on NA.uNewsId = N.uNewsId where N.uNewsId=@uNewsId         
      
 -- select(           
 -- select           
 -- uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsSchool,cIsTeacher,vText,dtCreatedOn,          
 -- dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId,          
 -- ISNULL((         
 -- select NT.*                              
 -- from t_LearnCoacher_News_ToUser NT                         
 -- where         
 --  NT.uNewsId = N.uNewsId         
 -- --AND N.cIsSchool = 'N'                     
 --for json path, INCLUDE_NULL_VALUES),'[]') as 'ToUserDetails' ,          
 --  ISNULL((select NA.*                              
 --from t_LearnCoacher_News_Attachment NA                         
 --where NA.uNewsId = N.uNewsId                      
 --for json path, INCLUDE_NULL_VALUES),'[]') as 'AttachmentDetails'                         
 -- for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News  N                    
 -- where iMainClientId=@iMainClientId       
 -- AND N.uNewsId = @uNewsId                                 
                                        
end 

Go

ALTER PROC [dbo].[JProc_LearnCoacher_SaveNews](                                        
 @uNewsId uniqueidentifier,                                        
 @iMainClientId int,                                        
 @uClassId uniqueidentifier,                                        
 @uFromId uniqueidentifier,                                        
 @uToId uniqueidentifier,                                        
 @vText varchar(8000),                                        
 @cIsPupil char(1),                                        
 @cIsTeacher char(1),                                        
 @cIsDeleted char(1),                                        
 @cIsToPupil char(1),                                        
 @cIsToTeacher char(1),                                        
 @cIsForGroup char(1),                                        
 @uGroupId uniqueidentifier,                                    
 @vFileJson nvarchar(max) = ''                                        
)                                        
as                                         
begin 

/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/                                       
  create table #tempRecords(uNewsAttachmentId uniqueidentifier)                                       
 if(@uNewsId = '00000000-0000-0000-0000-000000000000')                                        
 begin                                        
  set @uNewsId = NEWID();                           
                                     
  insert into t_LearnCoacher_News (uNewsId,	iMainClientId,	uClassId,	uUserId,	cIsPupil,	cIsTeacher,	vText,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	uOriginalNewsItemId,	uParentNewsItemId,	cIsSchool)
values(@uNewsId,@iMainClientId,@uClassId,@uFromId,@cIsPupil,@cIsTeacher,@vText,GETDATE(),GETDATE(),@cIsDeleted,null,null,null)                              
                            
                            
                            
    if(@cIsForGroup = 'Y')                          
  begin                          
 create table #tempGroupRecords(uUserId uniqueidentifier,cIsPupil char,cIsTeacher char)                           
 insert into #tempGroupRecords(uUserId,cIsPupil,cIsTeacher) select uUserId,cIsPupil,cIsTeacher from t_LearnCoacher_News_Group_User where uNewsGroupId=@uGroupId                          
                          
 DECLARE @MyCursor CURSOR;                          
 DECLARE @userid uniqueidentifier;                    
 DECLARE @cIsPupilGroupUser char;                    
 DECLARE @cIsTeacherGroupUser char;                          
 BEGIN                          
    SET @MyCursor = CURSOR FOR                          
    select  uUserId,cIsPupil,cIsTeacher from #tempGroupRecords                               
                          
    OPEN @MyCursor                           
    FETCH NEXT FROM @MyCursor                           
    INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                          
                          
    WHILE @@FETCH_STATUS = 0                          
    BEGIN                    
 DECLARE @cHasBeenViewed char;                    
 if(@userid = @uFromId)                    
 begin                    
  set @cHasBeenViewed='Y';                    
 end                    
 else                    
 begin                    
  set @cHasBeenViewed='N';                    
 end                          
      insert into t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
	  values(NEWID(),@uNewsId,@userid,@cIsPupilGroupUser,@cIsTeacherGroupUser,@cIsForGroup,@uGroupId,@cHasBeenViewed,@cIsDeleted)                           
           
      FETCH NEXT FROM @MyCursor                           
      INTO @userid,@cIsPupilGroupUser,@cIsTeacherGroupUser                           
    END;                           
                          
    CLOSE @MyCursor ;                          
    DEALLOCATE @MyCursor;                          
END;                          
  end                          
  else                          
  begin                          
    insert into t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)
	values(NEWID(),@uNewsId,@uToId,@cIsToPupil,@cIsToTeacher,@cIsForGroup,@uGroupId,'N',@cIsDeleted)                              
  end        
                                      
  declare @ClientFileName nvarchar(500)                                     
  declare @vFileType nvarchar(10)                                     
  declare @vFileSize int                                         
  declare cursor_SaveData Cursor For                                                    
    Select * from OPENJSON(@vFileJson)                     
    with(ClientFileName nvarchar(500) '$.ClientFileName',FileType nvarchar(10) '$.FileType',FileSize int '$.FileSize')                                 
  open cursor_SaveData                                                                         
 Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                              
   while(@@FETCH_STATUS <> -1)                                  
   Begin                                     
       declare @uNewsAttachmentId uniqueidentifier                                    
 set @uNewsAttachmentId= NEWID();                       
     insert into t_LearnCoacher_News_Attachment (uNewsAttachmentId,	uNewsId,	vAttachmentFileName,	iFileSizeInBytes,	vFileType,	iDisplayOrder,	vFileId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)  
	 values(@uNewsAttachmentId,@uNewsId,@ClientFileName,@vFileSize*1024,@vFileType,1,null,null,null,null)                                     
  insert into #tempRecords (uNewsAttachmentId)values(@uNewsAttachmentId)                                     
     Fetch Next from cursor_SaveData into @ClientFileName,@vFileType,@vFileSize                                        
   End                                    
      Close cursor_SaveData                                                                  
     Deallocate cursor_SaveData                                      
                                     
 select (select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,vText,dtCreatedOn,cIsDeleted for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News where uNewsId=@uNewsId                                


   
   
                                    
 end                                        
  select (select uNewsAttachmentId,uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder,vFileId for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment           
  where uNewsAttachmentId in(select uNewsAttachmentId from #tempRecords)                              
                              
                              
    select( select uNewsId,iMainClientId,uClassId,uUserId,cIsPupil,cIsTeacher,vText,dtCreatedOn,dtModifiedOn,cIsDeleted,uOriginalNewsItemId,uParentNewsItemId                               
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News                              
  where uClassId = @uClassId and cIsDeleted = 'N' and uNewsId=@uNewsId order by dtCreatedOn                              
                              
  select (select uNewsToUserId,N.uNewsId,TU.uUserId,TU.cIsPupil,TU.cIsTeacher,TU.cIsForGroup,TU.uGroupId,TU.cHasBeenViewed,TU.cIsDeleted                         
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_ToUser TU join t_LearnCoacher_News N                              
  on TU.uNewsId = N.uNewsId and N.uNewsId=@uNewsId where N.uClassId = @uClassId                              
                              
  select (select uNewsAttachmentId,N.uNewsId,vAttachmentFileName,iFileSizeInBytes,vFileType,iDisplayOrder                              
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Attachment NA join t_LearnCoacher_News N                              
  on NA.uNewsId = N.uNewsId where N.uClassId = @uClassId and N.cIsDeleted = 'N' and N.uNewsId=@uNewsId                                     
                                      
end 

Go

ALTER  PROC [dbo].[JProc_LearnCoacher_UpdateSchoolNewsViewedStatus]              
(                          
 @uUserId uniqueidentifier,             
 @uSchoolId uniqueidentifier,  
 @cIsTeacher  char(1),  
 @cIsPupil  char(1)  
)                
as                
begin  
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/          
DECLARE @tempNewsIds TABLE(uNewsId uniqueidentifier)             
   
   
   INSERT INTO @tempNewsIds   
   SELECT uNewsId from t_LearnCoacher_News N  
   WHERE N.cIsSchool = 'Y' and N.cIsDeleted = 'N' AND N.uUserId = @uSchoolId  
   Except  
   SELECT NT.uNewsid from t_LearnCoacher_News_ToUser NT  
   JOIN t_LearnCoacher_News N ON NT.uNewsId = N.uNewsId   
   WHERE   
  NT.uUserId = @uUserId AND N.cIsSchool = 'Y' and N.cIsDeleted = 'N'   
   AND N.uUserId = @uSchoolId   
  
   INSERT INTO t_LearnCoacher_News_ToUser (uNewsToUserId,	uNewsId,	uUserId,	cIsPupil,	cIsTeacher,	cIsForGroup,	uGroupId,	cHasBeenViewed,	cIsDeleted)  
   SELECT NEWID(),uNewsId,@uUserId,@cIsPupil,@cIsTeacher,'N','00000000-0000-0000-0000-000000000000','Y','N' FROM @tempNewsIds  
        
select(         
  select    
  N.uNewsId,  
  N.uUserId,    
  ISNULL((       
   select NT.*                            
   from t_LearnCoacher_News_ToUser NT                       
   where       
    NT.uNewsId = N.uNewsId       
   AND N.cIsSchool = 'Y'                   
 for json path, INCLUDE_NULL_VALUES),'[]') as 'ToUserDetails'                       
  for json path,include_null_values,without_array_wrapper) as JSONResult       
  from t_LearnCoacher_News  N      
  where uNewsId in(select uNewsId from @tempNewsIds)      
       
end 
go

ALTER PROCEDURE [dbo].[Proc_PlanenClassTime_AddClassTime](  
  
@strXml ntext,  
@uSchoolId uniqueidentifier  
)  
as  
  
/********************************************************************************************                
  
Created By:  Arun Menon       
Created Date: 07/08/2015        
Description:  New proc to Add/Edit School TimeTable       
  
 Modified By: Arvind K                                       
 Modified Date: 11/08/2020                                     
 Description: Included column list for Insert statements 
  
********************************************************************************************/        
Declare    
 @h int,                                
 @uClasstimeid uniqueidentifier,  
 @uschuleid uniqueidentifier,  
 @vClassTimeFrom nvarchar(200),  
 @vClassTimeTo nvarchar(200),  
 @iDisplayOrder int,  
 @cIsBreak char(1),  
 @cIsDeleted char(1),  
 @newid uniqueidentifier  
  
begin  
EXECUTE sp_xml_preparedocument @h OUTPUT,@strXml   
DECLARE Cursor_Elements CURSOR FOR  
SELECT                  
  ClassTimeId,  
  Schoolid,  
  FromSchoolTime,  
  ToSchoolTime,  
  DisplayOrder,  
  IsBreak,  
  IsDeleted  
  
  from OpenXml(@h,'/ClassTime',1)                              
    with(  
    ClassTimeId uniqueidentifier './@ClassTimeId',  
    Schoolid uniqueidentifier './@SchoolId',  
    FromSchoolTime nvarchar(200) './@FromTime',  
    ToSchoolTime nvarchar(200) './@ToTime',  
    DisplayOrder int './@DisplayOrder',  
    IsBreak char(1) './@IsBreak',  
    IsDeleted char(1) './@IsDeleted'  
  )  
  
  OPEN Cursor_Elements                                
           FETCH NEXT FROM Cursor_Elements INTO @uClasstimeid,@uschuleid,@vClassTimeFrom,@vClassTimeTo,@iDisplayOrder, @cIsBreak, @cIsDeleted   
     WHILE( @@Fetch_Status <> -1 )                                
      BEGIN                 
  
      IF (@uClasstimeid = '00000000-0000-0000-0000-000000000000' or @uClasstimeid is NULL)                                
           BEGIN   
     set @newid=newid();  
  
      INSERT INTO t_LearnCoacher_LearningJournal_TimeTable_Classtime (uClassTimeId,	uUserId,	vClassTimeFrom,	vClassTimeTo,	iDisplayOrder,	cIsBreak,	cIsDeleted)
	  values(@newid,@uschuleid,@vClassTimeFrom,@vClassTimeTo,@iDisplayOrder,@cIsBreak,@cIsDeleted)  
  
      select uClassTimeId from t_LearnCoacher_LearningJournal_TimeTable_Classtime where uClassTimeId=@newid;  
  
     END  
      ELSE  
        BEGIN  
  
      UPDATE t_LearnCoacher_LearningJournal_TimeTable_Classtime set uUserId=@uschuleid,vClassTimeFrom=@vClassTimeFrom,vClassTimeTo=@vClassTimeTo,  
      iDisplayOrder=@iDisplayOrder,cIsBreak=@cIsBreak,cIsDeleted=@cIsDeleted where uUserId=@uSchoolId and uClassTimeId=@uClasstimeid;  
     
      select uClassTimeId from t_LearnCoacher_LearningJournal_TimeTable_Classtime where uClassTimeId=@uClasstimeid;  
  
     END  
    FETCH NEXT FROM Cursor_Elements INTO @uClasstimeid,@uschuleid,@vClassTimeFrom,@vClassTimeTo,@iDisplayOrder, @cIsBreak, @cIsDeleted    
 END   
  CLOSE Cursor_Elements                                
         DEALLOCATE Cursor_Elements   
  
end 

Go
ALTER PROC [dbo].[JProc_LearnCoacher_SaveNewsGroup](                            
 @uNewsGroupId uniqueidentifier,                          
 @iMainClientId int,                            
 @uClassId uniqueidentifier,                            
 @uFromId uniqueidentifier,                                        
 @vGroupName nvarchar(1000),                            
 @cIsPupil char(1),                            
 @cIsTeacher char(1),                            
 @cIsDeleted char(1),                                                               
 @vFileJson nvarchar(max) = ''                            
)                            
as                             
begin        
/***********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
 Description: Included column list for Insert statements 
************************************************************/          
     --declare @uNewsGroupId uniqueidentifier                   
if(@uNewsGroupId ='00000000-0000-0000-0000-000000000000')              
begin              
  set @uNewsGroupId = NEWID();              
    insert into t_LearnCoacher_News_Group (uNewsGroupId,	iMainClientId,	uClassId,	vGroupName,	uUserId,	cIsTeacher,	cIsPupil,	dtCreatedOn,	cIsDeleted,	dtModifiedOn)    
 values(@uNewsGroupId,@iMainClientId,@uClassId,@vGroupName,@uFromId,@cIsTeacher,@cIsPupil,GETDATE(),@cIsDeleted,GETDATE())                 
end              
else              
begin              
 update t_LearnCoacher_News_Group set vGroupName=@vGroupName, dtModifiedOn=GETDATE() where uNewsGroupId=@uNewsGroupId              
 delete from t_LearnCoacher_News_Group_User  where uNewsGroupId=@uNewsGroupId              
end              
                       
  create table #tempRecords(uNewsGroupUserId uniqueidentifier)                           
        
         declare @uNewsGroupUserId uniqueidentifier                        
 set @uNewsGroupUserId= NEWID();        
insert into t_LearnCoacher_News_Group_User (uNewGroupUserId,	uNewsGroupId,	uUserId,	cIsPupil,	cIsTeacher,	cIsDeleted)
values(@uNewsGroupUserId,@uNewsGroupId,@uFromId,@cIsPupil,@cIsTeacher,'N')      
         
                                  
                        
  declare @Id uniqueidentifier             
  declare @cIsToPupil char(1)             
  declare @cIsToTeacher char(1)                                
  declare cursor_SaveData Cursor For                                                              
    Select * from OPENJSON(@vFileJson)                                                                            
    with(Id nvarchar(500) '$.Id',cIsToPupil char(1) '$.cIsToPupil',cIsToTeacher char(1) '$.cIsToTeacher')                                      
  open cursor_SaveData                                                             
 Fetch Next from cursor_SaveData into @Id,@cIsToPupil,@cIsToTeacher                                 
   while(@@FETCH_STATUS <> -1)                                                         
   Begin                         
       --declare @uNewsGroupUserId uniqueidentifier                        
 set @uNewsGroupUserId= NEWID();                           
      insert into t_LearnCoacher_News_Group_User (uNewGroupUserId,	uNewsGroupId,	uUserId,	cIsPupil,	cIsTeacher,	cIsDeleted)
	  values(NEWID(),@uNewsGroupId,@Id,@cIsToPupil,@cIsToTeacher,'N')                  
  insert into #tempRecords (uNewsGroupUserId)values(@uNewsGroupUserId)                         
     Fetch Next from cursor_SaveData into @Id,@cIsToPupil,@cIsToTeacher                           
   End                        
      Close cursor_SaveData                                                      
     Deallocate cursor_SaveData                           
                        
            select( select uNewsGroupId,iMainClientId,uClassId,vGroupName,uUserId,cIsTeacher,cIsPupil,dtCreatedOn,cIsDeleted             
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Group                  
  where iMainClientId=@iMainClientId  and uNewsGroupId=@uNewsGroupId              
                  
  select (select GU.uNewGroupUserId,GU.uNewsGroupId,GU.uUserId,GU.cIsPupil,GU.cIsTeacher                  
  for json path,include_null_values,without_array_wrapper) as JSONResult from t_LearnCoacher_News_Group_User GU join t_LearnCoacher_News_Group G                  
  on GU.uNewsGroupId = G.uNewsGroupId where G.iMainClientId = @iMainClientId  and GU.uNewsGroupId=@uNewsGroupId              
                     
                          
end

Go
ALTER PROCEDURE [dbo].[JProc_LearnCoacher_Document_AddFolder_1892018](                            
@uClassId uniqueidentifier,                    
@iMainClientId int,                    
@vFolderName VARCHAR(50),                    
@uUserId uniqueidentifier,                    
@cIsTeacher CHAR(1),                    
@cIsPupil CHAR(1),                    
@iLanguageId Int,                
@uParentDocumentFolderId uniqueidentifier,          
@cIsSchool char(1)='N',      
@cIsSchoolFolderForPupil char(1)='N',      
@cIsSchoolFolderForTeacher char(1)='N'                 
)                  
                
/*******************************************************************************                
 Created By:     Sanjay                 
 Created Date:                    
 Description:                       
                
 Modified By: Arvind K                                       
 Modified Date: 11/08/2020                                     
 Description: Included column list for Insert statements 
                 
 ********************************************************************************/                          
AS                            
BEGIN                      
                    
Declare @FolderId uniqueidentifier                    
SET @FolderId=NEWID()                    
                    
INSERT into t_LearnCoacher_Document_Folder (uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,dtCreatedOn,                    
dtModifiedOn,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher) values (@FolderId,@iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,'N',GETDATE(),GETDATE(),@uParentDocumentFolderId,@vFolderName,
@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher)                    
            
Insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
Select newid(),@FolderId,uUserId, cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uParentDocumentFolderId            
                    
select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher  ,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId

  
,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users    
 for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as                  
 JSONResult from t_LearnCoacher_Document_Folder F where uDocumentFolderId=@FolderId                    
                    
                     
--select ( select uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher, FU.cIsSchool for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult                   
--from t_LearnCoacher_Document_Folder_User FU Join  t_LearnCoacher_Document_Folder F ON                  
-- F.uDocumentFolderId=FU.uDocumentFolderId where F.uDocumentFolderId=@FolderId                         
                    
END 

GO

ALTER PROCEDURE [dbo].[JProc_LearnCoacher_Document_AddFolder_Final_07_08_2019]  
(                                
@uClassId uniqueidentifier,                        
@iMainClientId int,                        
@vFolderName VARCHAR(50),                        
@uUserId uniqueidentifier,                        
@cIsTeacher CHAR(1),                        
@cIsPupil CHAR(1),                        
@iLanguageId Int,                    
@uParentDocumentFolderId uniqueidentifier,              
@cIsSchool char(1)='N',          
@cIsSchoolFolderForPupil char(1)='N',          
@cIsSchoolFolderForTeacher char(1)='N'                     
)                      
                    
/*******************************************************************************                    
 Created By:     Sanjay                     
 Created Date:                        
 Description:                           
                    
 Modified By: Arvind K                                       
 Modified Date: 11/08/2020                                     
 Description: Included column list for Insert statements 
                     
 ********************************************************************************/                              
AS                                
BEGIN                          
                        
Declare @FolderId uniqueidentifier                        
SET @FolderId=NEWID()                        
                        
INSERT into t_LearnCoacher_Document_Folder (uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,dtCreatedOn,                        
dtModifiedOn,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher)   
values (@FolderId,@iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,'N',GETDATE(),GETDATE(),  
@uParentDocumentFolderId,@vFolderName,@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher)                        
                
Insert into t_LearnCoacher_Document_Folder_User(uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
Select newid(),@FolderId,uUserId, cIsPupil,cIsTeacher,cIsSchool from   
t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uParentDocumentFolderId                
                        
select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,  
cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher,dtCreatedOn,dtModifiedOn  ,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId  
,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId  
 for json path,INCLUDE_NULL_VALUES),'[]') Users        
 for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as                      
 JSONResult from t_LearnCoacher_Document_Folder F where uDocumentFolderId=@FolderId                        
                      
END 

GO
ALTER PROCEDURE [dbo].[JProc_LearnCoacher_Document_AssignUsers_Final](                        
@uDocumentFolderId uniqueidentifier,                
@JUserIds NVARCHAR(MAX) ,        
@uClassId uniqueidentifier         
)                        
AS                        
BEGIN                  
                
 DECLARE @uFolderId uniqueidentifier          
 BEGIN          
 WITH DocumentFolderLevels (uDocumentFolderId)                
   AS                
     (                
     -- Parent member definition                
   SELECT uDocumentFolderId                
   FROM t_LearnCoacher_Document_Folder                 
   WHERE uDocumentFolderId = @uDocumentFolderId               
   UNION ALL                
     -- Recursive member definition                
   SELECT P.uDocumentFolderId                
   FROM t_LearnCoacher_Document_Folder P                
   INNER JOIN DocumentFolderLevels AS F                
   ON P.uParentDocumentFolderId = F.uDocumentFolderId                    
     )           
      SELECT uDocumentFolderId INTO #tbl_FoldersAssign FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)            
         END          
  Delete t_LearnCoacher_Document_Folder_User where uDocumentFolderId in(select uDocumentFolderId from #tbl_FoldersAssign)         
              
             
       declare cursor_AssignUsers Cursor For                      
   Select uDocumentFolderId from #tbl_FoldersAssign                                    
     OPEN cursor_AssignUsers          
          
   FETCH NEXT FROM cursor_AssignUsers INTO @uFolderId          
          
   WHILE(@@FETCH_STATUS <> -1)          
   BEGIN          
    Insert into t_LearnCoacher_Document_Folder_User select newid(),@uFolderId,uUserId , cIsPupil, cIsTeacher,cIsSchool, NULL from openjson(@JUserIds) with (uUserId uniqueidentifier, cIsPupil char(1), cIsTeacher char(1), cIsSchool char(1))        
    Fetch Next from cursor_AssignUsers into @uFolderId                     
   End                
                 
  select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher  
  ,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId  ,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users   
    for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as   
JSONResult from             
t_LearnCoacher_Document_Folder F where uclassId=@uClassId and cIsDeleted = 'N'  and uDocumentFolderId in( select uDocumentFolderId from #tbl_FoldersAssign)        
               
--select ( select uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher,FU.cIsSchool   for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from            
-- t_LearnCoacher_Document_Folder_User FU Join  t_LearnCoacher_Document_Folder F ON            
-- F.uDocumentFolderId=FU.uDocumentFolderId where F.uClassId=@uClassId  and F.cIsDeleted = 'N'  and F.uDocumentFolderId in( select uDocumentFolderId from #tbl_FoldersAssign)        
                  
    DEALLOCATE cursor_AssignUsers          
          DROP table #tbl_FoldersAssign           
END 
GO

ALTER PROCEDURE [dbo].[JProc_LearnCoacher_Document_AssignUsers_Final_07_08_2019](                              
@uDocumentFolderId uniqueidentifier,                      
@JUserIds NVARCHAR(MAX) ,              
@uClassId uniqueidentifier               
)                              
AS                              
BEGIN                        
                      
 DECLARE @uFolderId uniqueidentifier                
 BEGIN                
 WITH DocumentFolderLevels (uDocumentFolderId)                      
   AS                      
     (                      
     -- Parent member definition                      
   SELECT uDocumentFolderId                      
   FROM t_LearnCoacher_Document_Folder                       
   WHERE uDocumentFolderId = @uDocumentFolderId                     
   UNION ALL                      
     -- Recursive member definition                      
   SELECT P.uDocumentFolderId                      
   FROM t_LearnCoacher_Document_Folder P                      
   INNER JOIN DocumentFolderLevels AS F                      
   ON P.uParentDocumentFolderId = F.uDocumentFolderId                          
     )                 
      SELECT uDocumentFolderId INTO #tbl_FoldersAssign FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                  
         END                
  Delete t_LearnCoacher_Document_Folder_User where uDocumentFolderId in(select uDocumentFolderId from #tbl_FoldersAssign)               
                    
                   
       declare cursor_AssignUsers Cursor For                            
   Select uDocumentFolderId from #tbl_FoldersAssign                                          
     OPEN cursor_AssignUsers                
                
   FETCH NEXT FROM cursor_AssignUsers INTO @uFolderId                
                
   WHILE(@@FETCH_STATUS <> -1)                
   BEGIN                
    Insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
	select newid(),@uFolderId,uUserId , cIsPupil, cIsTeacher,cIsSchool   
 from openjson(@JUserIds) with (uUserId uniqueidentifier, cIsPupil char(1), cIsTeacher char(1), cIsSchool char(1))              
    Fetch Next from cursor_AssignUsers into @uFolderId                           
   End                      
                       
  select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,  
  vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher,dtCreatedOn,dtModifiedOn        
  ,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId  ,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU   
   where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users         
    for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as         
JSONResult from                   
t_LearnCoacher_Document_Folder F where uclassId=@uClassId and cIsDeleted = 'N'  and uDocumentFolderId in( select uDocumentFolderId from #tbl_FoldersAssign)              
                     
    DEALLOCATE cursor_AssignUsers                
          DROP table #tbl_FoldersAssign                 
END 
GO

ALTER PROC [dbo].[JProc_LearnCoacher_Document_CopyFolder_Final](                            
@iMainClientId int,                              
@uClassId uniqueIdentifier,                              
@uUserId uniqueIdentifier,                              
@uSourceFolderId uniqueIdentifier,                              
@uTargetFolderId uniqueidentifier,                              
@cIsTeacher char(1),                              
@cIsPupil char(1),                    
@vResourceText nvarchar(max),                  
@cIsSchool char(1)='N'                          
)                              
AS                               
BEGIN                              
/********************************************************************************************                                                      
  Created By: Sanjay                                                     
  Created Date: 23.08.2018                                                     
  Description: Copy Folder To Another Folder                              
                                
 Modified By: Arvind K                                           
 Modified Date: 11/08/2020                                         
 Description: Included column list for Insert statements 
                              
  *************************************************************************************************/                              
  CREATE TABLE #tbl_Folders1(                              
  iIdentity int Identity(1,1),                              
  uOldFolderId uniqueIdentifier,                              
  uOldParentFolderId uniqueIdentifier,                              
  uNewFolderId uniqueIdentifier,                              
  uNewParentFolderId uniqueIdentifier                              
  )                            
  CREATE TABLE #tbl_Documents(                              
  uDocumentId uniqueIdentifier,                              
  vFileId nvarchar(max)                            
  )                            
                                
  BEGIN                            
   WITH DocumentFolderLevels (uDocumentFolderId,uParentDocumentFolderId)                                  
 AS                                  
 (                                  
 -- Parent member definition                                  
 SELECT uDocumentFolderId,uParentDocumentFolderId                                  
 FROM t_LearnCoacher_Document_Folder                                   
 WHERE uDocumentFolderId = @uSourceFolderId                                  
 UNION ALL                                  
 -- Recursive member definition                                  
 SELECT P.uDocumentFolderId,P.uParentDocumentFolderId                                   
 FROM t_LearnCoacher_Document_Folder P                                  
 INNER JOIN DocumentFolderLevels AS F                                  
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                                      
 )                             
 INSERT INTO #tbl_Folders1 select uDocumentFolderId,uParentDocumentFolderId ,null,null FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                             
END                            
                            
  DEClare @uDocumentId uniqueidentifier                            
  DECLARE @uDocumentFolderId uniqueidentifier                              
  DECLARE @uParentDocumentFolderId uniqueidentifier                              
  DECLARE @vFileId nvarchar(max) ,      
   @cIsSchoolFolderForPupil char(1),          
   @cIsSchoolFolderForTeacher char(1)                                
           
select  @cIsSchoolFolderForPupil =cIsSchoolFolderForPupil from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uTargetFolderId             
   select  @cIsSchoolFolderForTeacher =cIsSchoolFolderForTeacher from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uTargetFolderId                              
     If(@uTargetFolderId='00000000-0000-0000-0000-000000000016')        
   BEGIN        
   set @cIsSchoolFolderForPupil='Y'        
   set @cIsSchoolFolderForTeacher='N'        
   END        
   else if(@uTargetFolderId='00000000-0000-0000-0000-000000000001')        
   BEGIN        
    set @cIsSchoolFolderForPupil='N'        
   set @cIsSchoolFolderForTeacher='Y'        
   END                             
   DECLARE cursor_folderJson cursor for                              
   SELECT uOldFolderId,uOldParentFolderId from #tbl_Folders1                             
                                 
   OPEN cursor_folderJson                              
                              
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                            
                                  
   WHILE(@@FETCH_STATUS<>-1)                              
   BEGIN                              
                                 
   IF(@uDocumentFolderId = @uSourceFolderId)                              
   BEGIN                              
   SET  @uParentDocumentFolderId = @uTargetFolderId                              
   END                              
                              
   ELSE                    
   BEGIN                              
   SET @uParentDocumentFolderId = null                              
   END                              
                         DECLARE @newDocumentFolderId uniqueidentifier                              
   SET @newDocumentFolderId = NEWID()                              
    IF (@uDocumentFolderId=@uSourceFolderId)                              
   BEGIN                               
                     
 DECLARE @cExists int                        
  SET @cExists = 1                        
  DECLARE @iCount int                        
  SET @iCount =0                        
                           
     DECLARE @vFolderName nvarchar(500)                        
  SELECT @vFolderName = [vFolderName] FROM  t_LearnCoacher_Document_Folder where cIsDeleted = 'N' and uDocumentFolderId = @uSourceFolderId                         
                        
  DECLARE @vCopyName nvarchar(200)                        
                          
                                
  DECLARE @vTempString nvarchar(50)                        
  WHILE(@cExists > -1)                        
  BEGIN                        
   SET @vCopyName = @vResourceText + ' ' + @vFolderName                        
   IF(@iCount > 0)                        
    BEGIN                        
     SET @vTempString = '(' + Convert(nvarchar(20),@iCount) + ')'                        
     SET @vCopyName = @vCopyName + @vTempString                        
    END                        
    IF EXISTS(SELECT * FROM t_LearnCoacher_Document_Folder                         
       WHERE vFolderName = @vCopyname and uParentDocumentFolderId = @uTargetFolderId and cIsDeleted = 'N' )                        
      BEGIN                        
       SET @iCount = @iCount + 1                        
      END                         
    ELSE                        
     BEGIN                        
      SET @cExists = -1                        
     END                        
  END                    
                    
 insert into t_LearnCoacher_Document_Folder (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, cIsSchool, 
 cIsSchoolFolderForPupil, cIsSchoolFolderForTeacher)    
 select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,GETDATE(),GETDATE(),cIsDeleted,@uParentDocumentFolderId,@vCopyName,@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher      
         
         
from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                            
   END                      
   ELSE              
   BEGIN                    
   insert into t_LearnCoacher_Document_Folder (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, cIsSchool, cIsSchoolFolderForPupil, 
   cIsSchoolFolderForTeacher)     
   select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,GETDATE(),GETDATE(),cIsDeleted,@uParentDocumentFolderId,vFolderName,@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher 
   from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                            
   END                            
                            
                               
                       
    if exists(select * from t_LearnCoacher_Document_Folder_User where uDocumentFolderId =@uTargetFolderId)                            
  BEGIN                            
  insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
  select newid(),@newDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User where  uDocumentFolderId =@uTargetFolderId                             
  END                             
                               
    if exists(select * from t_LearnCoacher_Document where uDocumentFolderId =@uDocumentFolderId and cIsDeleted='N')                            
     BEGIN                             
                                
  DECLARE cursor_Documents cursor for  select uDocumentId , vFileId from t_LearnCoacher_Document where @uDocumentFolderId =uDocumentFolderId and cIsDeleted='N'                            
  OPEN cursor_Documents                              
    FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                            
    WHILE(@@FETCH_STATUS<>-1)                              
    BEGIN                              
     DECLARE @uNewDocumentId uniqueidentifier                              
     SET @uNewDocumentId = NEWID()                              
                                
      INSERT INTO t_LearnCoacher_Document (uDocumentId,	iMainClientId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	vFileId,	vFileName,	vFileType,	iFileSizeInBytes,	cIsSchool,	uClassId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)
	  select @uNewDocumentId,@iMainClientId,@newDocumentFolderId,@uUserId,@cIsPupil,@cIsTeacher,GETDATE(),GETDATE(),'N',NULL,vFileName,vFileType,iFileSizeInBytes,@cIsSchool,uClassId, NULL,NULL,NULL 
	  from t_LearnCoacher_Document where uDocumentId =@uDocumentId                              
      --for returning                               
      INSERT INTO #tbl_Documents VALUES(@uNewDocumentId,@vFileId)                              
                                 
      FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                            
  END                              
  close cursor_Documents                            
  deallocate cursor_Documents                            
  END              
                               
                              
                              
   UPDATE #tbl_Folders1 SET uNewFolderId = @newDocumentFolderId WHERE uOldFolderId= @uDocumentFolderId                             
                                
   UPDATE #tbl_Folders1 SET uNewParentFolderId = @newDocumentFolderId WHERE uOldParentFolderId =@uDocumentFolderId                             
                               
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                              
  END                               
                                
                              
                              
                              
  DECLARE @intCount int, @intMaxCount int                                        
                              
  SET @intCount = 1                                        
                              
  SELECT @intMaxCount = COUNT(*) FROM #tbl_Folders1                                       
                              
  WHILE(@intCount <= @intMaxCount)                                        
                              
  BEGIN                                        
               
   DECLARE @uTempOldFolderId uniqueidentifier, @uTempNewFolderId uniqueidentifier, @uTempNewParentFolderId uniqueidentifier                                        
                              
   SELECT @uTempOldFolderId =uOldFolderId,  @uTempNewFolderId = uNewFolderId, @uTempNewParentFolderId = uNewParentFolderId  from #tbl_Folders1 where iIdentity = @intCount             
                              
   IF(@uTempOldFolderId != @uSourceFolderId )-- don't update the first folder                                        
                              
   BEGIN                                        
                              
    update t_LearnCoacher_Document_Folder SET uParentDocumentFolderId = @uTempNewParentFolderId WHERE uDocumentFolderId = @uTempNewFolderId                                        
                              
   END                                        
                              
   SET @intCount = @intCount+1                                        
                              
  End                                      
                              
                                 
 SELECT (SELECT uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher   ,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUser

Id,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users              
   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM                                 
 t_LearnCoacher_Document_Folder F WHERE uDocumentFolderId in(SELECT uNewFolderId FROM #tbl_Folders1)                                 
                                   
 --SELECT ( SELECT uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher,FU.cIsSchool   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM                              
 --t_LearnCoacher_Document_Folder_User FU WHERE  FU.uDocumentFolderId in(SELECT uNewFolderId FROM #tbl_Folders1)                                  
                             
 SELECT (SELECT D.uDocumentId,D.iMainClientId,D.uDocumentFolderId,D.uUserId,D.cIsPupil,D.cIsTeacher,D.cIsDeleted,D.dtCreatedOn,dtModifiedOn,vFileId,vFileName,vFileType,iFileSizeInBytes ,D.cIsSchool,D.uClassId 
 FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper)            
              
                
 AS JSONResult  FROM t_LearnCoacher_Document D                                
 where D.uDocumentId in(SELECT uDocumentId from #tbl_Documents)                              
                                
 SELECT(SELECT uDocumentId,vFileId  FOR json PATH, include_null_values, without_array_wrapper) AS JSONResult FROM #tbl_Documents                            
                            
                                 
                              
   DROP TABLE #tbl_Documents                              
   DROP TABLE #tbl_Folders1                            
   CLOSE cursor_folderJson                              
   DEALLOCATE cursor_folderJson                              
                                 
   END 

Go

ALTER PROC [dbo].[JProc_LearnCoacher_Document_CopyFolder_Final_07_08_2019](                              
@iMainClientId int,                                
@uClassId uniqueIdentifier,                                
@uUserId uniqueIdentifier,                                
@uSourceFolderId uniqueIdentifier,                                
@uTargetFolderId uniqueidentifier,                                
@cIsTeacher char(1),                                
@cIsPupil char(1),                      
@vResourceText nvarchar(max),                    
@cIsSchool char(1)='N'                            
)                                
AS                                 
BEGIN                                
/********************************************************************************************                                                        
  Created By: Sanjay                                                       
  Created Date: 23.08.2018                                                       
  Description: Copy Folder To Another Folder                                
                                  
 Modified By: Arvind K                                           
 Modified Date: 11/08/2020                                         
 Description: Included column list for Insert statements 
                                
  *************************************************************************************************/                                
  CREATE TABLE #tbl_Folders1(                                
  iIdentity int Identity(1,1),                                
  uOldFolderId uniqueIdentifier,                                
  uOldParentFolderId uniqueIdentifier,                                
  uNewFolderId uniqueIdentifier,                                
  uNewParentFolderId uniqueIdentifier                                
  )                              
  CREATE TABLE #tbl_Documents(                                
  uDocumentId uniqueIdentifier,                                
  vFileId nvarchar(max)                              
  )                              
                                  
  BEGIN                              
   WITH DocumentFolderLevels (uDocumentFolderId,uParentDocumentFolderId)                                    
 AS                                    
 (                                    
 -- Parent member definition                                    
 SELECT uDocumentFolderId,uParentDocumentFolderId                                    
 FROM t_LearnCoacher_Document_Folder                                     
 WHERE uDocumentFolderId = @uSourceFolderId                                    
 UNION ALL                                    
 -- Recursive member definition                                    
 SELECT P.uDocumentFolderId,P.uParentDocumentFolderId                                     
 FROM t_LearnCoacher_Document_Folder P                                    
 INNER JOIN DocumentFolderLevels AS F                                    
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                                        
 )                               
 INSERT INTO #tbl_Folders1 select uDocumentFolderId,uParentDocumentFolderId ,null,null FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                               
END                              
                              
  DEClare @uDocumentId uniqueidentifier                              
  DECLARE @uDocumentFolderId uniqueidentifier                                
  DECLARE @uParentDocumentFolderId uniqueidentifier                                
  DECLARE @vFileId nvarchar(max) ,        
   @cIsSchoolFolderForPupil char(1),            
   @cIsSchoolFolderForTeacher char(1)                                  
             
select  @cIsSchoolFolderForPupil =cIsSchoolFolderForPupil from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uTargetFolderId               
   select  @cIsSchoolFolderForTeacher =cIsSchoolFolderForTeacher from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uTargetFolderId                                
     If(@uTargetFolderId='00000000-0000-0000-0000-000000000016')          
   BEGIN          
   set @cIsSchoolFolderForPupil='Y'          
   set @cIsSchoolFolderForTeacher='N'          
   END          
   else if(@uTargetFolderId='00000000-0000-0000-0000-000000000001')          
   BEGIN          
   set @cIsSchoolFolderForPupil='N'          
   set @cIsSchoolFolderForTeacher='Y'          
   END                               
   DECLARE cursor_folderJson cursor for                                
   SELECT uOldFolderId,uOldParentFolderId from #tbl_Folders1                               
                                   
   OPEN cursor_folderJson                                
                                
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                              
                                    
   WHILE(@@FETCH_STATUS<>-1)                                
   BEGIN                                
                                   
   IF(@uDocumentFolderId = @uSourceFolderId)                                
   BEGIN                                
   SET  @uParentDocumentFolderId = @uTargetFolderId                                
   END                                
                                
   ELSE                      
   BEGIN                                
   SET @uParentDocumentFolderId = null                                
   END                                
                         DECLARE @newDocumentFolderId uniqueidentifier                                
   SET @newDocumentFolderId = NEWID()                                
    IF (@uDocumentFolderId=@uSourceFolderId)                                
   BEGIN                                 
                       
 DECLARE @cExists int                          
  SET @cExists = 1                          
  DECLARE @iCount int                          
  SET @iCount =0                          
                             
     DECLARE @vFolderName nvarchar(500)                          
  SELECT @vFolderName = [vFolderName] FROM  t_LearnCoacher_Document_Folder where cIsDeleted = 'N' and uDocumentFolderId = @uSourceFolderId                           
                          
  DECLARE @vCopyName nvarchar(200)                          
                            
                                  
  DECLARE @vTempString nvarchar(50)                          
  WHILE(@cExists > -1)                          
  BEGIN                          
   SET @vCopyName = @vResourceText + ' ' + @vFolderName                          
   IF(@iCount > 0)                          
    BEGIN                          
     SET @vTempString = '(' + Convert(nvarchar(20),@iCount) + ')'                          
     SET @vCopyName = @vCopyName + @vTempString                          
    END                          
    IF EXISTS(SELECT * FROM t_LearnCoacher_Document_Folder                           
       WHERE vFolderName = @vCopyname and uParentDocumentFolderId = @uTargetFolderId and cIsDeleted = 'N' )                          
      BEGIN                          
       SET @iCount = @iCount + 1                          
      END                           
    ELSE                          
     BEGIN                          
      SET @cExists = -1                          
     END                          
  END                      
                      
 insert into t_LearnCoacher_Document_Folder  (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, cIsSchool, 
 cIsSchoolFolderForPupil, cIsSchoolFolderForTeacher)      
 select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,GETDATE(),GETDATE(),      
 cIsDeleted,@uParentDocumentFolderId,@vCopyName,@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher       
from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                              
   END                        
   ELSE                      
   BEGIN                      
 insert into t_LearnCoacher_Document_Folder (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, 
 cIsSchool, cIsSchoolFolderForPupil, cIsSchoolFolderForTeacher)    
 select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,      
   @cIsPupil,GETDATE(),GETDATE(),cIsDeleted,@uParentDocumentFolderId,vFolderName,@cIsSchool,@cIsSchoolFolderForPupil,@cIsSchoolFolderForTeacher     
   from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                              
   END                              
                              
                          
                         
    if exists(select * from t_LearnCoacher_Document_Folder_User where uDocumentFolderId =@uTargetFolderId)                              
  BEGIN                              
  insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
select newid(),@newDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool       
  from t_LearnCoacher_Document_Folder_User where  uDocumentFolderId =@uTargetFolderId                               
  END                               
                                 
    if exists(select * from t_LearnCoacher_Document where uDocumentFolderId =@uDocumentFolderId and cIsDeleted='N')                              
     BEGIN                               
                                  
  DECLARE cursor_Documents cursor for  select uDocumentId , vFileId from t_LearnCoacher_Document where @uDocumentFolderId =uDocumentFolderId       
  and cIsDeleted='N'                              
  OPEN cursor_Documents                                
    FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                              
    WHILE(@@FETCH_STATUS<>-1)                                
    BEGIN                                
     DECLARE @uNewDocumentId uniqueidentifier                                
     SET @uNewDocumentId = NEWID()                                
                                  
      INSERT INTO t_LearnCoacher_Document  (uDocumentId,	iMainClientId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	vFileId,	vFileName,	vFileType,	iFileSizeInBytes,	cIsSchool,	uClassId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)
     
   select @uNewDocumentId,@iMainClientId,@newDocumentFolderId,@uUserId,@cIsPupil,@cIsTeacher,GETDATE(),GETDATE()      
   ,'N',NULL,vFileName,vFileType,iFileSizeInBytes,@cIsSchool,uClassId, NULL,NULL,NULL       
   from t_LearnCoacher_Document where uDocumentId =@uDocumentId                                
      --for returning                                 
      INSERT INTO #tbl_Documents VALUES(@uNewDocumentId,@vFileId)                                
                                   
      FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                              
  END                                
  close cursor_Documents                              
  deallocate cursor_Documents                              
  END                
                                 
                                
                                
   UPDATE #tbl_Folders1 SET uNewFolderId = @newDocumentFolderId WHERE uOldFolderId= @uDocumentFolderId   
                                  
   UPDATE #tbl_Folders1 SET uNewParentFolderId = @newDocumentFolderId WHERE uOldParentFolderId =@uDocumentFolderId                               
                                 
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                                
  END                                 
                                  
                                
                                
                                
  DECLARE @intCount int, @intMaxCount int                                          
                                
  SET @intCount = 1                                          
                                
  SELECT @intMaxCount = COUNT(*) FROM #tbl_Folders1                                         
                                
  WHILE(@intCount <= @intMaxCount)                                          
                                
  BEGIN                                          
                                
   DECLARE @uTempOldFolderId uniqueidentifier, @uTempNewFolderId uniqueidentifier, @uTempNewParentFolderId uniqueidentifier                                          
                                
   SELECT @uTempOldFolderId =uOldFolderId,  @uTempNewFolderId = uNewFolderId, @uTempNewParentFolderId = uNewParentFolderId        
   from #tbl_Folders1 where iIdentity = @intCount                                           
                                
   IF(@uTempOldFolderId != @uSourceFolderId )-- don't update the first folder                                          
                                
   BEGIN                                          
                                
    update t_LearnCoacher_Document_Folder SET uParentDocumentFolderId = @uTempNewParentFolderId WHERE uDocumentFolderId = @uTempNewFolderId                                
                                
   END                                          
                                
   SET @intCount = @intCount+1                                          
                                
  End                                        
                                
                                   
 SELECT (SELECT uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,      
 vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher ,dtCreatedOn,dtModifiedOn  ,      
 ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool       
 from t_LearnCoacher_Document_Folder_User FU       
  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users                
   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM                                   
 t_LearnCoacher_Document_Folder F WHERE uDocumentFolderId in(SELECT uNewFolderId FROM #tbl_Folders1)                                   
                          
 SELECT (SELECT D.uDocumentId,D.iMainClientId,D.uDocumentFolderId,D.uUserId,D.cIsPupil,D.cIsTeacher,D.cIsDeleted,D.dtCreatedOn,      
 dtModifiedOn,vFileId,vFileName,vFileType,iFileSizeInBytes ,D.cIsSchool,D.uClassId FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper)              
                
                  
 AS JSONResult  FROM t_LearnCoacher_Document D                                  
 where D.uDocumentId in(SELECT uDocumentId from #tbl_Documents)                                
                                  
 SELECT(SELECT uDocumentId,vFileId  FOR json PATH, include_null_values, without_array_wrapper) AS JSONResult FROM #tbl_Documents                              
                              
                                   
                                
   DROP TABLE #tbl_Documents                                
   DROP TABLE #tbl_Folders1                              
   CLOSE cursor_folderJson                                
   DEALLOCATE cursor_folderJson                                
                                   
   END 
Go

ALTER PROC [dbo].[JProc_LearnCoacher_Document_CopyFolder_New](                        
@iMainClientId int,                          
@uClassId uniqueIdentifier,                          
@uUserId uniqueIdentifier,                          
@uSourceFolderId uniqueIdentifier,                          
@uTargetFolderId uniqueidentifier,                          
@cIsTeacher char(1),                          
@cIsPupil char(1),                
@vResourceText nvarchar(max),              
@cIsSchool char(1)='N'                      
)                          
AS                           
BEGIN                          
/********************************************************************************************                                                  
  Created By: Sanjay                                                 
  Created Date: 23.08.2018                                                 
  Description: Copy Folder To Another Folder                          
                            
 Modified By: Arvind K                                         
 Modified Date: 12/08/2020                                       
 Description: Included default value for uModifiedByUserId column                                                 
                          
  *************************************************************************************************/                          
  CREATE TABLE #tbl_Folders1(                          
  iIdentity int Identity(1,1),                          
  uOldFolderId uniqueIdentifier,                          
  uOldParentFolderId uniqueIdentifier,                          
  uNewFolderId uniqueIdentifier,                          
  uNewParentFolderId uniqueIdentifier                          
  )                        
  CREATE TABLE #tbl_Documents(                          
  uDocumentId uniqueIdentifier,                          
  vFileId nvarchar(max)                        
  )                        
                            
  BEGIN                        
   WITH DocumentFolderLevels (uDocumentFolderId,uParentDocumentFolderId)                              
 AS                              
 (                              
 -- Parent member definition                              
 SELECT uDocumentFolderId,uParentDocumentFolderId                              
 FROM t_LearnCoacher_Document_Folder                               
 WHERE uDocumentFolderId = @uSourceFolderId                              
 UNION ALL                              
 -- Recursive member definition                              
 SELECT P.uDocumentFolderId,P.uParentDocumentFolderId                               
 FROM t_LearnCoacher_Document_Folder P                              
 INNER JOIN DocumentFolderLevels AS F                              
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                                  
 )                         
 INSERT INTO #tbl_Folders1 select uDocumentFolderId,uParentDocumentFolderId ,null,null FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                         
END                        
                        
  DEClare @uDocumentId uniqueidentifier                        
  DECLARE @uDocumentFolderId uniqueidentifier                          
  DECLARE @uParentDocumentFolderId uniqueidentifier                          
  DECLARE @vFileId nvarchar(max)                           
                           
                        
   DECLARE cursor_folderJson cursor for                          
   SELECT uOldFolderId,uOldParentFolderId from #tbl_Folders1                         
                             
   OPEN cursor_folderJson                          
                          
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                        
                              
   WHILE(@@FETCH_STATUS<>-1)         
   BEGIN                          
                             
   IF(@uDocumentFolderId = @uSourceFolderId)          
   BEGIN                          
   SET  @uParentDocumentFolderId = @uTargetFolderId                          
   END                          
                          
   ELSE                           
   BEGIN                          
   SET @uParentDocumentFolderId = null                          
   END                          
                         DECLARE @newDocumentFolderId uniqueidentifier                          
   SET @newDocumentFolderId = NEWID()                          
    IF (@uDocumentFolderId=@uSourceFolderId)                          
   BEGIN                           
                 
 DECLARE @cExists int                    
  SET @cExists = 1                    
  DECLARE @iCount int                    
  SET @iCount =0                    
                       
     DECLARE @vFolderName nvarchar(500)                    
  SELECT @vFolderName = [vFolderName] FROM  t_LearnCoacher_Document_Folder where cIsDeleted = 'N' and uDocumentFolderId = @uSourceFolderId                     
                    
  DECLARE @vCopyName nvarchar(200)                    
                      
                            
  DECLARE @vTempString nvarchar(50)                    
  WHILE(@cExists > -1)                    
  BEGIN                    
   SET @vCopyName = @vResourceText + ' ' + @vFolderName                    
   IF(@iCount > 0)                    
    BEGIN                    
     SET @vTempString = '(' + Convert(nvarchar(20),@iCount) + ')'                    
     SET @vCopyName = @vCopyName + @vTempString                    
    END                    
    IF EXISTS(SELECT * FROM t_LearnCoacher_Document_Folder                     
       WHERE vFolderName = @vCopyname and uParentDocumentFolderId = @uTargetFolderId and cIsDeleted = 'N' )                    
      BEGIN                    
       SET @iCount = @iCount + 1                    
      END                     
    ELSE                    
     BEGIN                    
      SET @cExists = -1                    
     END                    
  END                
                
 insert into t_LearnCoacher_Document_Folder  (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, 
 cIsSchool, cIsSchoolFolderForPupil, cIsSchoolFolderForTeacher)    
select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,GETDATE(),GETDATE(),cIsDeleted,@uParentDocumentFolderId,@vCopyName,@cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher       
        
          
from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                        
   END                  
   ELSE                
   BEGIN                
   insert into t_LearnCoacher_Document_Folder  (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName, cIsSchool, 
   cIsSchoolFolderForPupil, cIsSchoolFolderForTeacher)    
select @newDocumentFolderId,iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,GETDATE(),GETDATE(),cIsDeleted,@uParentDocumentFolderId,vFolderName,@cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher    
  from t_LearnCoacher_Document_Folder where uDocumentFolderId = @uDocumentFolderId and cIsDeleted ='N'                        
   END                        
                        
                           
                   
    if exists(select * from t_LearnCoacher_Document_Folder_User where uDocumentFolderId =@uTargetFolderId)                        
  BEGIN                        
  insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
select newid(),@newDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool  from t_LearnCoacher_Document_Folder_User where  uDocumentFolderId =@uTargetFolderId                         
  END                         
                           
    if exists(select * from t_LearnCoacher_Document where uDocumentFolderId =@uDocumentFolderId and cIsDeleted='N')                        
     BEGIN                         
                            
  DECLARE cursor_Documents cursor for  select uDocumentId , vFileId from t_LearnCoacher_Document where @uDocumentFolderId =uDocumentFolderId and cIsDeleted='N'                        
  OPEN cursor_Documents                          
    FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                        
    WHILE(@@FETCH_STATUS<>-1)                          
    BEGIN                          
     DECLARE @uNewDocumentId uniqueidentifier                          
     SET @uNewDocumentId = NEWID()                          
                            
      INSERT INTO t_LearnCoacher_Document (uDocumentId,	iMainClientId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	vFileId,	vFileName,	vFileType,	iFileSizeInBytes,	cIsSchool,	uClassId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)
select @uNewDocumentId,@iMainClientId,@newDocumentFolderId,@uUserId,@cIsPupil,@cIsTeacher,GETDATE(),GETDATE(),'N',NULL,vFileName,vFileType,iFileSizeInBytes,@cIsSchool,uClassId, NULL,NULL,NULL  
from t_LearnCoacher_Document where uDocumentId =@uDocumentId                          
      --for returning                
      INSERT INTO #tbl_Documents VALUES(@uNewDocumentId,@vFileId)                          
                             
      FETCH FROM cursor_Documents INTO @uDocumentId,@vFileId                        
  END                          
  close cursor_Documents                        
  deallocate cursor_Documents                        
  END          
                           
                          
                          
   UPDATE #tbl_Folders1 SET uNewFolderId = @newDocumentFolderId WHERE uOldFolderId= @uDocumentFolderId                         
                            
   UPDATE #tbl_Folders1 SET uNewParentFolderId = @newDocumentFolderId WHERE uOldParentFolderId =@uDocumentFolderId                         
                           
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId                          
  END                           
                            
                          
                          
                          
  DECLARE @intCount int, @intMaxCount int                                    
                          
  SET @intCount = 1                                    
                          
  SELECT @intMaxCount = COUNT(*) FROM #tbl_Folders1                                   
                          
  WHILE(@intCount <= @intMaxCount)                                    
                          
  BEGIN                                    
                          
   DECLARE @uTempOldFolderId uniqueidentifier, @uTempNewFolderId uniqueidentifier, @uTempNewParentFolderId uniqueidentifier                                    
                          
   SELECT @uTempOldFolderId =uOldFolderId,  @uTempNewFolderId = uNewFolderId, @uTempNewParentFolderId = uNewParentFolderId  from #tbl_Folders1 where iIdentity = @intCount                                     
                          
   IF(@uTempOldFolderId != @uSourceFolderId )-- don't update the first folder                                    
                          
   BEGIN                                    
                          
    update t_LearnCoacher_Document_Folder SET uParentDocumentFolderId = @uTempNewParentFolderId WHERE uDocumentFolderId = @uTempNewFolderId              
                          
   END                                    
                          
   SET @intCount = @intCount+1                                    
                          
  End                                  
                          
                             
 SELECT (SELECT uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher   ,
 ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users          
   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM                             
 t_LearnCoacher_Document_Folder F WHERE uDocumentFolderId in(SELECT uNewFolderId FROM #tbl_Folders1)                             
                               
 --SELECT ( SELECT uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher,FU.cIsSchool   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM                          
 --t_LearnCoacher_Document_Folder_User FU WHERE  FU.uDocumentFolderId in(SELECT uNewFolderId FROM #tbl_Folders1)                              
                         
 SELECT (SELECT D.uDocumentId,D.iMainClientId,D.uDocumentFolderId,D.uUserId,D.cIsPupil,D.cIsTeacher,D.cIsDeleted,D.dtCreatedOn,dtModifiedOn,vFileId,vFileName,vFileType,iFileSizeInBytes ,D.cIsSchool,D.uClassId 
 FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper)        
          
            
 AS JSONResult  FROM t_LearnCoacher_Document D                            
 where D.uDocumentId in(SELECT uDocumentId from #tbl_Documents)                          
                            
 SELECT(SELECT uDocumentId,vFileId  FOR json PATH, include_null_values, without_array_wrapper) AS JSONResult FROM #tbl_Documents                        
                           
                             
                          
   DROP TABLE #tbl_Documents                          
   DROP TABLE #tbl_Folders1                        
   CLOSE cursor_folderJson                          
   DEALLOCATE cursor_folderJson                          
                             
   END 

GO
ALTER PROC [dbo].[JProc_LearnCoacher_Document_CopyFolders](      
@nvarFoldersJson nvarchar(max)='',      
@iMainClientId int,      
@uClassId uniqueIdentifier,      
@uUserId uniqueIdentifier,      
@uSourceFolderId uniqueIdentifier,      
@uTargetFolderId uniqueidentifier,      
@cIsTeacher char(1),      
@cIsPupil char(1),      
@nvarDocumentJson nvarchar(max) = '',      
@iLanguageId int      
)      
AS       
BEGIN      
/********************************************************************************************                              
  Created By: Sanjay                             
  Created Date: 23.08.2018                             
  Description: Copy Folder To Another Folder      
        
 Modified By: Arvind K    
 Modified Date: 11/08/2020      
 Description: Included column list for Insert statements                              
      
  *************************************************************************************************/      
      
  CREATE TABLE #temptable(      
  iIdentity int Identity(1,1),      
  uOldFolderId uniqueIdentifier,      
  uOldParentFolderId uniqueIdentifier,      
  uNewFolderId uniqueIdentifier,      
  uNewParentFolderId uniqueIdentifier      
  )      
      
  DECLARE @oldFolderId uniqueidentifier      
  DECLARE @oldParentFolderId uniqueidentifier      
  DECLARE @uDocumentFolderId uniqueidentifier      
  DECLARE @uParentDocumentFolderId uniqueidentifier      
  DECLARE @dtCreatedOn datetime      
  DECLARE @dtModifiedOn datetime      
  DECLARE @cIsDeleted char(1)      
  DECLARE @nFileName nvarchar(150)      
  DECLARE @nvarUsersJson nvarchar(max) = ''      
        
      
  INSERT INTO #temptable(      
  uOldFolderId,uOldParentFolderId)      
  SELECT *       
  FROM openjson(@nvarFoldersJson) with(      
  oldFolderId uniqueIdentifier '$.uDocumentFolderId',oldParentFolderId uniqueIdentifier '$.uParentDocumentFolderId'      
  )      
      
   DECLARE cursor_folderJson cursor for      
   SELECT * from openjson(@nvarFoldersJson)      
   WITH(      
   uDocumentFolderId uniqueidentifier '$.uDocumentFolderId',      
   uDocumentParentFolderId uniqueidentifier '$.uParentDocumentFolderId',      
   nFileName char(150) '$.De.vFolderName',      
   nvarUsersJson nvarchar(max) '$.Users' as json      
   )      
      
   OPEN cursor_folderJson      
      
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId,@nFileName,@nvarUsersJson      
      
        
   WHILE(@@FETCH_STATUS<>-1)      
   BEGIN      
         
   IF(@uDocumentFolderId = @uSourceFolderId)      
   BEGIN      
   SET  @uParentDocumentFolderId = @uTargetFolderId      
   END      
      
   ELSE       
   BEGIN      
   SET @uParentDocumentFolderId = null      
   END      
      
   DECLARE @newDocumentFolderId uniqueidentifier      
   SET @newDocumentFolderId = NEWID()      
   SET @dtCreatedOn = GETDATE()      
    IF (@uDocumentFolderId=@uSourceFolderId)      
   BEGIN       
   SET @nFileName = 'Kopie  ' + @nFileName       
   END      
   INSERT INTO t_LearnCoacher_Document_Folder  (uDocumentFolderId, iMainClientId, uClassId, uUserId, cIsTeacher, cIsPupil, dtCreatedOn, dtModifiedOn, cIsDeleted, uParentDocumentFolderId, vFolderName)    
   VALUES(@newDocumentFolderId,@iMainClientId,@uClassId,@uUserId,@cIsTeacher,@cIsPupil,@dtCreatedOn,@dtModifiedOn,'N',@uParentDocumentFolderId,@nFileName)      
      
   IF(@@ROWCOUNT >0)--if folder row insertion is success then insert row of folderData      
   BEGIN      
   DECLARE @newDocumentFolderdataId uniqueidentifier      
   SET @newDocumentFolderdataId = NEWID()      
      
        
      
   --INSERT INTO t_LearnCoacher_Document_Folder_Data values(@newDocumentFolderdataId,@newDocumentFolderId,@iLanguageId,@nFileName)      
   END      
      
   --for user information      
   DECLARE @uFolderUserId uniqueidentifier      
      
   DECLARE cursor_UsersJson CURSOR FOR      
   SELECT * from openjson(@nvarUsersJson)      
   WITH(      
   uFolderUserId uniqueidentifier '$.uUserId'      
   )      
      
   OPEN cursor_UsersJson      
   FETCH NEXT FROM cursor_UsersJson INTO @uFolderUserId      
        
   WHILE(@@FETCH_STATUS<>-1)      
   BEGIN       
   DECLARE @uDocumentFolderUserId uniqueidentifier      
   SET @uDocumentFolderUserId = NEWID()      
      
   INSERT INTO t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
VALUES(@uDocumentFolderUserId,@newDocumentFolderId,@uFolderUserId,@cIsPupil,@cIsTeacher, NULL)      
   FETCH NEXT FROM cursor_UsersJson INTO @uFolderUserId      
   END      
   CLOSE cursor_UsersJson      
   DEALLOCATE cursor_UsersJson      
      
      
   UPDATE #temptable SET uNewFolderId = @newDocumentFolderId WHERE @uDocumentFolderId = uOldFolderId      
        
   UPDATE #temptable SET uNewParentFolderId = @newDocumentFolderId WHERE @uDocumentFolderId = uOldParentFolderId      
       
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId,@uParentDocumentFolderId,@nFileName,@nvarUsersJson      
  END       
        
      
      
      
  DECLARE @intCount int, @intMaxCount int                
      
  SET @intCount = 1                
      
  SELECT @intMaxCount = COUNT(*) FROM #temptable               
      
  WHILE(@intCount <= @intMaxCount)                
      
  BEGIN                
      
   DECLARE @uTempOldFolderId uniqueidentifier, @uTempNewFolderId uniqueidentifier, @uTempNewParentFolderId uniqueidentifier                
      
   SELECT @uTempOldFolderId =uOldFolderId,  @uTempNewFolderId = uNewFolderId, @uTempNewParentFolderId = uNewParentFolderId  from #temptable where iIdentity = @intCount                 
      
   IF(@uTempOldFolderId != @uSourceFolderId )-- don't update the first folder                
      
   BEGIN                
      
    update t_LearnCoacher_Document_Folder SET uParentDocumentFolderId = @uTempNewParentFolderId WHERE uDocumentFolderId = @uTempNewFolderId                
      
   END                
      
   SET @intCount = @intCount+1                
      
  End              
  CREATE TABLE #tempDocumentTable(      
 uOldFolderId uniqueidentifier,      
 uNewFolderId uniqueidentifier,      
 uOldDocumentId uniqueidentifier,      
 uNewDocumentId uniqueidentifier      
 )      
      
  --code for inserting files      
  DECLARE @uDocumentId uniqueidentifier,@uDocumentFolderIdInFile uniqueidentifier,  @vFileName varchar(50), @iFileSizeInBytes int, @vFileType varchar(50)       
  DECLARE cursor_Documents cursor for      
  SELECT * FROM openjson(@nvarDocumentJson)WITH(      
  uDocumentId uniqueidentifier '$.uDocumentId',      
  uDocumentFolderIdInFile uniqueidentifier '$.uDocumentFolderId',      
  vFileName varchar(50) '$.De.vFileName',      
  iFileSizeInBytes int '$.De.iFileSizeInBytes',      
  vFileType varchar(50) '$.De.vFileType'      
  )      
      
  OPEN cursor_Documents      
  FETCH FROM cursor_Documents INTO @uDocumentId,@uDocumentFolderIdInFile,@vFileName,@iFileSizeInBytes,@vFileType      
  WHILE(@@FETCH_STATUS<>-1)      
  BEGIN      
  DECLARE @uNewDocumentId uniqueidentifier      
  SET @uNewDocumentId = NEWID()      
  DECLARE @uTempNewFolderIdForDocuments uniqueidentifier      
  SELECT @uTempNewFolderIdForDocuments =  uNewFolderId  FROM #temptable WHERE uOldFolderId = @uDocumentFolderIdInFile      
        
   INSERT INTO t_LearnCoacher_Document (uDocumentId,	iMainClientId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	dtCreatedOn,	dtModifiedOn,	cIsDeleted,	vFileId,	vFileName,	vFileType,	iFileSizeInBytes,	cIsSchool,	uClassId,	cIsFromOldOneDrive,	cIsUploadedToOneDrive,	iNumberOfAttempts)
VALUES(@uNewDocumentId,@iMainClientId,@uTempNewFolderIdForDocuments,@uUserId,@cIsPupil,@cIsTeacher,GETDATE(),null,'N',NULL,@vFileName,@vFileType,@iFileSizeInBytes, NULL, NULL, NULL,NULL,NULL)      
      
   --INSERT INTO t_Learncoacher_Document_Data VALUES(NEWID(),@uNewDocumentId,@iLanguageId,@vFileName,@iFileSizeInBytes,@vFileType)      
   --for returning       
   INSERT INTO #tempDocumentTable VALUES(@uDocumentFolderIdInFile,@uTempNewFolderIdForDocuments,@uDocumentId,@uNewDocumentId)      
         
   FETCH FROM cursor_Documents INTO @uDocumentId,@uDocumentFolderIdInFile,@vFileName,@iFileSizeInBytes,@vFileType      
      
  END      
        
   --select(select @@ROWCOUNT as affectedRowCount  for json path, include_null_values, without_array_wrapper) as jsonresult    
   --exec JProc_LearnCoacher_Document_GetFolders @uClassId      
         
   SELECT (SELECT uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId  FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM         
t_LearnCoacher_Document_Folder WHERE uDocumentFolderId in(SELECT uNewFolderId FROM #temptable)         
          
SELECT ( SELECT uDocumentFolderDataId,FD.uDocumentFolderId,iLanguageId,vFolderName   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM      
t_LearnCoacher_Document_Folder_Data FD  WHERE  FD.uDocumentFolderId in(SELECT uNewFolderId FROM #temptable)         
           
SELECT ( SELECT uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher   FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM      
 t_LearnCoacher_Document_Folder_User FU WHERE  FU.uDocumentFolderId in(SELECT uNewFolderId FROM #temptable)          
         
         
          
   --exec JProc_LearnCoacher_Document_GetDocuments @uClassId       
   SELECT (SELECT D.uDocumentId,D.iMainClientId,D.uDocumentFolderId,D.uUserId,D.cIsPupil,D.cIsTeacher,D.cIsDeleted,D.dtCreatedOn FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult  FROM t_LearnCoacher_Document D        
  where D.uDocumentFolderId in(SELECT uNewFolderId from #tempDocumentTable)      
        
        
SELECT ( SELECT DD.uDocumentDataId,DD.uDocumentId,DD.iLanguageId,DD.vFileName,DD.iFileSizeInBytes,DD.vFileType,D.dtCreatedOn  FOR json PATH,INCLUDE_NULL_VALUES, without_array_wrapper) AS JSONResult FROM t_LearnCoacher_Document_Data DD      
 join t_LearnCoacher_Document D ON D.uDocumentId=DD.uDocumentId join        
 t_LearnCoacher_Document_Folder DF ON DF.uDocumentFolderId = D.uDocumentFolderId WHERE DF.uDocumentFolderId in(SELECT uNewFolderId FROM #tempDocumentTable)      
      
      
      
   SELECT(SELECT uOldFolderId,uNewFolderId,uOldDocumentId,uNewDocumentId  FOR json PATH, include_null_values, without_array_wrapper) AS JSONResult FROM #tempDocumentTable      
      
   DROP TABLE #tempDocumentTable      
   CLOSE cursor_Documents      
  DEALLOCATE cursor_Documents      
  DROP TABLE #temptable      
   CLOSE cursor_folderJson      
   DEALLOCATE cursor_folderJson      
         
   END 


Go

ALTER  PROC [dbo].[JProc_LearnCoacher_Document_MoveFolders_1892018](@uCopyFolderId uniqueidentifier, @uCopyToFolderId uniqueidentifier, @uClassId uniqueidentifier)                    
AS                     
BEGIN                    
                    
/********************************************************************************************                                            
  Created By: Sanjay                                           
  Created Date: 17.08.2018                                           
  Description: Move Folder To Another Folder                    
                      
 Modified By: Arvind K                                         
 Modified Date: 12/08/2020                                       
 Description: Included default value for uModifiedByUserId column                                           
                    
  *************************************************************************************************/                    
  declare @uDocumentFolderId uniqueidentifier              
  CREATE TABLE #tbl_Folders1(                      
  uDocumentFolderId uniqueIdentifier              
  )                
                    
update t_LearnCoacher_Document_Folder set uParentDocumentFolderId = @uCopyToFolderId                    
where uDocumentFolderId = @uCopyFolderId                 
              
BEGIN                    
   WITH DocumentFolderLevels (uDocumentFolderId)                          
 AS                          
 (                          
 -- Parent member definition                          
 SELECT uDocumentFolderId                        
 FROM t_LearnCoacher_Document_Folder                           
 WHERE uDocumentFolderId = @uCopyFolderId                          
 UNION ALL                          
 -- Recursive member definition                          
 SELECT P.uDocumentFolderId                           
 FROM t_LearnCoacher_Document_Folder P                          
 INNER JOIN DocumentFolderLevels AS F                          
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                              
 )                     
 INSERT INTO #tbl_Folders1 select uDocumentFolderId  FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                     
END                   
              
 DECLARE cursor_folderJson cursor for                      
   SELECT uDocumentFolderId from #tbl_Folders1                     
   OPEN cursor_folderJson                      
                      
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId                  
                          
   WHILE(@@FETCH_STATUS<>-1)                      
   BEGIN                  
   delete t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uDocumentFolderId              
   insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
select NEWID(),@uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from   t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uCopyToFolderId                 
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId              
    END              
                  
select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher    
,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users        
  for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from                     
t_LearnCoacher_Document_Folder F where uclassId=@uClassId and cIsDeleted = 'N'                   
                       
--select ( select uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher,FU.cIsSchool   for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from                    
-- t_LearnCoacher_Document_Folder_User FU Join  t_LearnCoacher_Document_Folder F ON                    
-- F.uDocumentFolderId=FU.uDocumentFolderId where F.uClassId=@uClassId  and F.cIsDeleted = 'N'                    
 deallocate cursor_folderJson              
 DROP table #tbl_Folders1              
END 

GO
ALTER PROC [dbo].[JProc_LearnCoacher_Document_MoveFolders_Final](@uCopyFolderId uniqueidentifier, @uCopyToFolderId uniqueidentifier, @uClassId uniqueidentifier)                              
AS                               
BEGIN                              
                              
/********************************************************************************************                                                      
  Created By: Sanjay                                                     
  Created Date: 17.08.2018                                                     
  Description: Move Folder To Another Folder                              
                                
 Modified By: Arvind K                                       
 Modified Date: 12/08/2020                                     
 Description: Included default value for uModifiedByUserId column                                                     
                              
  *************************************************************************************************/                              
  declare @uDocumentFolderId uniqueidentifier,        
    @cIsSchoolFolderForPupil char(1),        
   @cIsSchoolFolderForTeacher char(1),  
   @uUserId uniqueidentifier                     
  CREATE TABLE #tbl_Folders1(                                
  uDocumentFolderId uniqueIdentifier                        
  )                          
                              
update t_LearnCoacher_Document_Folder set uParentDocumentFolderId = @uCopyToFolderId                              
where uDocumentFolderId = @uCopyFolderId        
select  @cIsSchoolFolderForPupil =cIsSchoolFolderForPupil from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uCopyToFolderId           
   select  @cIsSchoolFolderForTeacher =cIsSchoolFolderForTeacher from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uCopyToFolderId    
   select  @uUserId =uUserId from    t_LearnCoacher_Document_Folder     where uDocumentFolderId = @uCopyToFolderId       
                            
   If(@uCopyToFolderId='00000000-0000-0000-0000-000000000016')      
   BEGIN      
   set @cIsSchoolFolderForPupil='Y'      
   set @cIsSchoolFolderForTeacher='N'      
   END      
   else if(@uCopyToFolderId='00000000-0000-0000-0000-000000000001')      
   BEGIN      
    set @cIsSchoolFolderForPupil='N'      
   set @cIsSchoolFolderForTeacher='Y'      
   END     
   else if(@uCopyToFolderId='00000000-0000-0000-0000-000000000000')      
   BEGIN      
    set @cIsSchoolFolderForPupil='N'      
   set @cIsSchoolFolderForTeacher='N'      
   END     
         
  update t_LearnCoacher_Document_Folder set cIsSchoolFolderForPupil =@cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher = @cIsSchoolFolderForTeacher,uUserId = @uUserId where uDocumentFolderId = @uCopyFolderId                
BEGIN                              
   WITH DocumentFolderLevels (uDocumentFolderId)                                    
 AS                                    
 (                                    
 -- Parent member definition                                    
 SELECT uDocumentFolderId                                  
 FROM t_LearnCoacher_Document_Folder                                     
 WHERE uDocumentFolderId = @uCopyFolderId                                    
 UNION ALL                                    
 -- Recursive member definition                                    
 SELECT P.uDocumentFolderId                                     
 FROM t_LearnCoacher_Document_Folder P                                    
 INNER JOIN DocumentFolderLevels AS F                                    
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                                        
 )                               
 INSERT INTO #tbl_Folders1 select uDocumentFolderId  FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                               
END                             
                        
 DECLARE cursor_folderJson cursor for                                
   SELECT uDocumentFolderId from #tbl_Folders1                               
   OPEN cursor_folderJson                                
                                
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId                            
                                    
   WHILE(@@FETCH_STATUS<>-1)                                
   BEGIN                            
   delete t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uDocumentFolderId                        
   insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
select NEWID(),@uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from   t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uCopyToFolderId                           
   update t_LearnCoacher_Document_Folder set cIsSchoolFolderForPupil =@cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher = @cIsSchoolFolderForTeacher,uUserId=@uUserId where uDocumentFolderId = @uDocumentFolderId         
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId                        
    END                        
                            
select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher    
,ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU  where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users                  
  for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from                               
t_LearnCoacher_Document_Folder F where uclassId=@uClassId and cIsDeleted = 'N' and (uDocumentFolderId in(select uDocumentFolderId from   #tbl_Folders1) or uDocumentFolderId =@uCopyFolderId)                          
                                 
--select ( select uDocumentFolderUserId,FU.uDocumentFolderId,FU.uUserId,FU.cIsPupil,FU.cIsTeacher,FU.cIsSchool   for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from                              
-- t_LearnCoacher_Document_Folder_User FU Join  t_LearnCoacher_Document_Folder F ON                   
-- F.uDocumentFolderId=FU.uDocumentFolderId where F.uClassId=@uClassId  and F.cIsDeleted = 'N'                 
 deallocate cursor_folderJson                        
 DROP table #tbl_Folders1                        
END 

GO
ALTER PROC [dbo].[JProc_LearnCoacher_Document_MoveFolders_Final_07_08_2019](  
@uCopyFolderId uniqueidentifier, @uCopyToFolderId uniqueidentifier, @uClassId uniqueidentifier  
)                                
AS                                 
BEGIN                                
                                
/********************************************************************************************                                                        
  Created By: Sanjay                                                       
  Created Date: 17.08.2018                                                       
  Description: Move Folder To Another Folder                                
                                  
 Modified By: Arvind K                                       
 Modified Date: 12/08/2020                                     
 Description: Included default value for uModifiedByUserId column                                                        
                                
  *************************************************************************************************/                                
  declare @uDocumentFolderId uniqueidentifier,          
    @cIsSchoolFolderForPupil char(1),          
   @cIsSchoolFolderForTeacher char(1),    
   @uUserId uniqueidentifier                       
  CREATE TABLE #tbl_Folders1(                                  
  uDocumentFolderId uniqueIdentifier                          
  )                            
                                
update t_LearnCoacher_Document_Folder set uParentDocumentFolderId = @uCopyToFolderId                                
where uDocumentFolderId = @uCopyFolderId          
select  @cIsSchoolFolderForPupil =cIsSchoolFolderForPupil from    t_LearnCoacher_Document_Folder      
 where uDocumentFolderId = @uCopyToFolderId             
   select  @cIsSchoolFolderForTeacher =cIsSchoolFolderForTeacher from    t_LearnCoacher_Document_Folder       
   where uDocumentFolderId = @uCopyToFolderId      
   select  @uUserId =uUserId from    t_LearnCoacher_Document_Folder       
   where uDocumentFolderId = @uCopyToFolderId         
                              
   If(@uCopyToFolderId='00000000-0000-0000-0000-000000000016')        
   BEGIN        
   set @cIsSchoolFolderForPupil='Y'        
   set @cIsSchoolFolderForTeacher='N'        
   END        
   else if(@uCopyToFolderId='00000000-0000-0000-0000-000000000001')        
   BEGIN        
    set @cIsSchoolFolderForPupil='N'        
   set @cIsSchoolFolderForTeacher='Y'        
   END       
   else if(@uCopyToFolderId='00000000-0000-0000-0000-000000000000')        
   BEGIN        
    set @cIsSchoolFolderForPupil='N'        
   set @cIsSchoolFolderForTeacher='N'        
   END       
           
  update t_LearnCoacher_Document_Folder set cIsSchoolFolderForPupil =@cIsSchoolFolderForPupil,  
  cIsSchoolFolderForTeacher = @cIsSchoolFolderForTeacher,uUserId = @uUserId where uDocumentFolderId = @uCopyFolderId                  
BEGIN                                
   WITH DocumentFolderLevels (uDocumentFolderId)                                      
 AS                                      
 (                                      
 -- Parent member definition                                      
 SELECT uDocumentFolderId                                    
 FROM t_LearnCoacher_Document_Folder                                       
 WHERE uDocumentFolderId = @uCopyFolderId                                      
 UNION ALL                                      
 -- Recursive member definition                                      
 SELECT P.uDocumentFolderId                                       
 FROM t_LearnCoacher_Document_Folder P                                      
 INNER JOIN DocumentFolderLevels AS F                                      
 ON P.uParentDocumentFolderId = F.uDocumentFolderId                   
 )                                 
 INSERT INTO #tbl_Folders1 select uDocumentFolderId  FROM DocumentFolderLevels  OPTION (MAXRECURSION 0)                                 
END                               
                          
 DECLARE cursor_folderJson cursor for      
   SELECT uDocumentFolderId from #tbl_Folders1                                 
   OPEN cursor_folderJson                                  
                                  
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId                              
                                      
   WHILE(@@FETCH_STATUS<>-1)                                  
   BEGIN                              
   delete t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uDocumentFolderId                          
   insert into t_LearnCoacher_Document_Folder_User (uDocumentFolderUserId,	uDocumentFolderId,	uUserId,	cIsPupil,	cIsTeacher,	cIsSchool)
select NEWID(),@uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool   
   from   t_LearnCoacher_Document_Folder_User where uDocumentFolderId = @uCopyToFolderId                             
   update t_LearnCoacher_Document_Folder set cIsSchoolFolderForPupil =@cIsSchoolFolderForPupil,  
   cIsSchoolFolderForTeacher = @cIsSchoolFolderForTeacher,uUserId=@uUserId where uDocumentFolderId = @uDocumentFolderId           
   FETCH NEXT FROM cursor_folderJson INTO @uDocumentFolderId                          
    END                          
                              
select (select uDocumentFolderId,iMainClientId,uClassId,uUserId,cIsTeacher,cIsPupil,cIsDeleted,uParentDocumentFolderId,vFolderName,  
cIsSchool,cIsSchoolFolderForPupil,cIsSchoolFolderForTeacher  ,dtCreatedOn,dtModifiedOn  ,  
ISNULL((select uDocumentFolderUserId,uDocumentFolderId,uUserId,cIsPupil,cIsTeacher,cIsSchool from t_LearnCoacher_Document_Folder_User FU   
 where FU.uDocumentFolderId = F.uDocumentFolderId for json path,INCLUDE_NULL_VALUES),'[]') Users                    
  for json path,INCLUDE_NULL_VALUES, without_array_wrapper) as JSONResult from                                 
t_LearnCoacher_Document_Folder F where uclassId=@uClassId and cIsDeleted = 'N' and   
(uDocumentFolderId in(select uDocumentFolderId from   #tbl_Folders1) or uDocumentFolderId =@uCopyFolderId)                            
                  
 deallocate cursor_folderJson                          
 DROP table #tbl_Folders1                          
END 

Go

ALTER PROCEDURE [dbo].[Proc_Extranet_Planner_SaveCurriculumDetails](  
@strXml ntext,  
@cismultiplecompetencypresent char(1),  
@cisfileuploaded char(1),  
@cisnewcurriculum char(1)  
)  
as   
/********************************************************************************************                
  
Created By:  Arun Menon       
Created Date: 28/10/2015        
Description:  New proc to add/edit Curriculum  Data    
       
  
 Modified By: Arvind K                                       
 Modified Date: 12/08/2020                                     
 Description: Included column list for Insert statements 
  
********************************************************************************************/    
  
BEGIN  
 DECLARE @strmainxml XML = @strXml;  
 DECLARE @uCurriculumId uniqueidentifier;  
 DECLARE @iMainClientId int;  
 DECLARE @vNotes nvarchar(MAX);  
 DECLARE @iSubSubjectId int;  
 DECLARE @iCategoryId int;  
 DECLARE @cIsDeleted char(1);  
 DECLARE @dtCreatedOn datetime;  
 DECLARE @uUserId uniqueidentifier;  
  
 DECLARE @vFileName nvarchar(250);  
 DECLARE @vFileVersion char(1);  
 DECLARE @vFileType nvarchar(10);  
 DECLARE @uCurriculumCompetencyId uniqueidentifier;  
 DECLARE @iCategoryCompetencyId int;  
 DECLARE @uSegmentId uniqueidentifier;  
 DECLARE @dtSegmentCurriculumDate datetime;  
  
  if(@cisnewcurriculum='Y')  
  begin  
    set @uCurriculumId= newid();  
  
    insert into t_Testdrive_Planner_Curriculum (uCurriculumId,	iMainClientId,	vNotes,	iSubSubjectId,	iCategoryId,	cIsDeleted,	dtCreatedOn,	dtModifiedOn,	uUserId) 
     SELECT   
     @uCurriculumId,  
     col.value('(@iMainClientId)[1]', 'int'),  
     col.value('(@vNotes)[1]', 'nvarchar(MAX)'),  
     col.value('(@iSubSubjectId)[1]', 'int'),  
     col.value('(@iCategoryId)[1]', 'int'),  
     col.value('(@cIsDeleted)[1]', 'char(1)'),  
     col.value('(@dtCreatedOn)[1]', 'datetime'),  
     getdate(),  
     col.value('(@uUserId)[1]', 'uniqueidentifier')
  
    FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col);  
          
     if(@cisfileuploaded='Y')  
       Begin  
      DECLARE cur_attachments CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
        SELECT   
         col.value('(@vFileName)[1]','nvarchar(250)'),  
         col.value('(@vFileVersion)[1]','char(1)'),  
         col.value('(@vFileType)[1]','nvarchar(10)')  
  
        FROM @strmainxml.nodes('/CurriculumData/CurriculumAttachments/CurriculumAttachment') tab(col)  
       OPEN cur_attachments  
       FETCH NEXT FROM cur_attachments INTO @vFileName, @vFileVersion,@vFileType  
       WHILE @@FETCH_STATUS<>-1  
        begin  
         insert into t_TestDrive_Planner_Curriculum_Attachment   
         values(newid(),@uCurriculumId,@vFileName,@vFileType,@vFileVersion,'N');  
         FETCH NEXT FROM cur_attachments INTO  @vFileName, @vFileVersion,@vFileType  
        end  
       CLOSE cur_attachments  
       DEALLOCATE cur_attachments  
       End  
  
      if(@cismultiplecompetencypresent='Y')  
      Begin  
       DECLARE cur_competencies CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
         SELECT   
          col.value('(@iCategoryCompetencyId)[1]','int')  
               
        FROM @strmainxml.nodes('/CurriculumData/CurriculumCompetencies/CurriculumCompetency') tab(col)  
        OPEN cur_competencies  
        FETCH NEXT FROM cur_competencies INTO @iCategoryCompetencyId  
        WHILE @@FETCH_STATUS<>-1  
         begin  
          insert into t_TestDrive_Planner_Curriculum_Competency   
          values(newid(),@uCurriculumId,@iCategoryCompetencyId);  
          FETCH NEXT FROM cur_competencies INTO  @iCategoryCompetencyId  
         end  
        CLOSE cur_competencies  
        DEALLOCATE cur_competencies  
        End  
  
    insert into t_TestDrive_Planner_Segment_Curriculum  
      SELECT   
      newid(),  
      @uCurriculumId,  
      col.value('(@uSegmentId)[1]', 'uniqueidentifier'),  
      col.value('(@dtSegmentCurriculumDate)[1]', 'datetime')  
  
      FROM @strmainxml.nodes('/CurriculumData/CurriculumSegments/CurriculumSegment') tab(col);  
    end  
    
   else  
  
    begin  
    update t_Testdrive_Planner_Curriculum set iMainClientId=col.value('(@iMainClientId)[1]', 'int'),vNotes=col.value('(@vNotes)[1]', 'nvarchar(MAX)'),  
    iSubSubjectId= col.value('(@iSubSubjectId)[1]', 'int'),  
    iCategoryId=col.value('(@iCategoryId)[1]', 'int'),dtModifiedOn=GETDATE(),uUserId=col.value('(@uUserId)[1]', 'uniqueidentifier')   
    FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col)  
    where uCurriculumId=col.value('(@uCurriculumId)[1]', 'uniqueidentifier');  
  
    select @uCurriculumId=col.value('(@uCurriculumId)[1]', 'uniqueidentifier') FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col);  
  
       if(@cisfileuploaded='Y')  
       Begin  
      DECLARE cur_attachments CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
        SELECT   
         col.value('(@uCurriculumId)[1]', 'uniqueidentifier'),  
         col.value('(@vFileName)[1]','nvarchar(250)'),  
         col.value('(@vFileVersion)[1]','char(1)'),  
         col.value('(@vFileType)[1]','nvarchar(10)')  
  
        FROM @strmainxml.nodes('/CurriculumData/CurriculumAttachments/CurriculumAttachment') tab(col)  
       OPEN cur_attachments  
       FETCH NEXT FROM cur_attachments INTO @uCurriculumId,@vFileName, @vFileVersion,@vFileType  
       WHILE @@FETCH_STATUS<>-1  
        begin  
         insert into t_TestDrive_Planner_Curriculum_Attachment   
         values(newid(),@uCurriculumId,@vFileName,@vFileType,@vFileVersion,'N');  
         FETCH NEXT FROM cur_attachments INTO  @uCurriculumId,@vFileName, @vFileVersion,@vFileType  
        end  
       CLOSE cur_attachments  
       DEALLOCATE cur_attachments  
       End  
        
          if(@cismultiplecompetencypresent='Y')  
      Begin  
       DECLARE cur_competencies CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
         SELECT   
          col.value('(@uCurriculumCompetencyId)[1]', 'uniqueidentifier'),  
          col.value('(@iCategoryCompetencyId)[1]','int')  
               
        FROM @strmainxml.nodes('/CurriculumData/CurriculumCompetencies/CurriculumCompetency') tab(col)  
        OPEN cur_competencies  
        FETCH NEXT FROM cur_competencies INTO @uCurriculumCompetencyId,@iCategoryCompetencyId  
        WHILE @@FETCH_STATUS<>-1  
         begin  
             if(@uCurriculumCompetencyId='00000000-0000-0000-0000-000000000000')  
            begin  
               insert into t_TestDrive_Planner_Curriculum_Competency   
               values(newid(),@uCurriculumId,@iCategoryCompetencyId);  
            end  
          else  
             begin  
                update t_TestDrive_Planner_Curriculum_Competency set iCategoryCompetencyId=@iCategoryCompetencyId  
                where uCurriculumCompetencyId=@uCurriculumCompetencyId;  
             end  
          FETCH NEXT FROM cur_competencies INTO  @uCurriculumCompetencyId,@iCategoryCompetencyId  
         end  
        CLOSE cur_competencies  
        DEALLOCATE cur_competencies  
        End  
  
  
    end  
  
   select * from t_Testdrive_Planner_Curriculum where uCurriculumId=@uCurriculumId;  
   select * from t_TestDrive_Planner_Curriculum_Attachment where uCurriculumId=@uCurriculumId;  
   select * from t_TestDrive_Planner_Curriculum_Competency where uCurriculumId=@uCurriculumId;  
   select * from t_TestDrive_Planner_Curriculum_CompetencyCandoItem where uCurriculumId=@uCurriculumId;  
   select * from t_TestDrive_Planner_Segment_Curriculum where uCurriculumId=@uCurriculumId;  
   
END

Go
ALTER PROC [dbo].[JProc_LearnCoacher_Document_View_Final]                
(                
 @uDocumentId uniqueidentifier,                
 @uUserId uniqueidentifier,                
 @cIsPupil char(1),                
 @cIsTeacher char(1),          
 @cIsSchool char(1) ='N',    
 @uClassId uniqueidentifier               
 )                
AS                
BEGIN  
/*********************************************************
Modified By: Arvind K    
Modified Date: 11/08/2020      
Description: Included column list for Insert statements 
 **********************************************************/              
 declare @myId uniqueidentifier              
 if not exists(select uDocumentUserId from t_Learncoacher_Document_User where uDocumentId = @uDocumentId and uUserId=@uUserId)                
 begin                
 set @myId= NEWID()              
  insert into t_LearnCoacher_Document_User (uDocumentUserId,	uDocumentId,	uUserId,	cIsPupil,	cIsTeacher,	cHasViewed, cIsSchool,uClassId)
values(@myId,@uDocumentId,@uUserId,@cIsPupil,@cIsTeacher,'Y',@cIsSchool,@uClassId)                
  select (select uDocumentUserId,uDocumentId,uUserId,cIsPupil,cIsTeacher,cHasViewed,cIsSchool,uClassId  for json path,include_null_values,without_array_wrapper) as JSONResult  from  t_LearnCoacher_Document_User where uDocumentUserId=@myId              
 end                
 ELSE              
 BEGIN               
 select (select uDocumentUserId,uDocumentId,uUserId,cIsPupil,cIsTeacher,cHasViewed ,cIsSchool,uClassId for json path,include_null_values,without_array_wrapper) as JSONResult  from  t_LearnCoacher_Document_User where uDocumentId = @uDocumentId and uUserId=

  
@uUserId     
      
            
 END              
END 

Go
ALTER PROC [dbo].[JProc_TestDrive_StellwerkZurich_SavePupilExternalMapping]                              
 (                              
  @vPupilDataJson NVARCHAR(Max),                        
  @vSchoolDataJson NVARCHAR(Max),                          
  @iMainClientId INT,                        
  @vAction nvarchar(50)                             
 )                              
 AS                                    
 BEGIN transaction;                        
/********************************************************************************************                                                      
  Created By: Arvind Sharma                                                     
  Created Date: 18.04.2018                                                     
  Description: Adds/Edits external Pupil data for Zurich                              
                              
  Modified By:   Ayyappa                                                    
  Modified Date: 20-06-2018                                               
  Description:   Modified t_TestDrive_Member_School_Pupil Select statement                                         
                              
*************************************************************************************************/                            
--Checks for School existence, if not then add                    
                    
  declare @vExternalSchoolId nvarchar(max),                            
     @uSchoolId uniqueidentifier,                      
     @vSubData nvarchar(max)                      
                             
                      
       declare  Cur_School cursor for select value from openjson(@vSchoolDataJson)                      
     open Cur_School                      
      fetch next from Cur_School into @vSubData                      
   WHILE(@@FETCH_STATUS<>-1)                      
    BEGIN                      
    select @vExternalSchoolId = ID  from openjson(@vSubData) with (ID nvarchar(50))                      
    if not exists(select * from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = @vExternalSchoolId and iMainclientId =@iMainClientId)                      
    BEGIN                      
      set @uSchoolId=NEWID();                            
    insert into t_TestDrive_Member_School_ExternalSourceMapping (uSchoolId,uSchoolExternalSourceIdGuid,iMainClientId,uSchoolExternalSourceId,dtCreatedOn,dtModifiedOn)
	select @uSchoolId, newid(), @iMainClientId,ID,GETDATE(),GETDATE()   from OPENJSON(@vSchoolDataJson) with (ID nvarchar(500))                             
    Insert into t_TestDrive_Member_School(uSchoolId,vSchoolName,vStreet,iZIPCode,vTown,iMainClientId,iStateId,iTitleId,vFirstName,vName,vPhone,vEmail,cIsExternalMember) values(@uSchoolId, '','','','',@iMainClientId,551,0,'','','0000','test@arcadix.com','Y
')                    
  
     END                      
    fetch next from Cur_School into @vSubData                      
    END                      
    Close Cur_School                      
    Deallocate Cur_School                      
                    
                      
   declare @vExternalPupilId nvarchar(max),                              
     @uPupilId uniqueidentifier,                        
     @cIsAdmin char(1)                        
                                 
   select @vExternalPupilId= ID  from openjson(@vPupilDataJson) with (ID nvarchar(50))                              
                           
   IF(@vAction='DELETE')                        
   BEGIN                        
   if exists(select * from t_TestDrive_Member_Pupil_ExternalSourceMapping where iMainclientId=@iMainClientId and uPupilExternalSourceId = @vExternalPupilId)                              
 BEGIN                              
  select @uPupilId = uPupilId from t_TestDrive_Member_Pupil_ExternalSourceMapping where iMainclientId=@iMainClientId and uPupilExternalSourceId = @vExternalPupilId                           
  update t_TestDrive_Member_School_Pupil set cIsDeleted ='Y' where uPupilId =@uPupilId                         
 END                        
   END                        
   ELSE                        
   BEGIN                        
                                    
 if exists(select * from t_TestDrive_Member_Pupil_ExternalSourceMapping where iMainclientId=@iMainClientId and uPupilExternalSourceId = @vExternalPupilId)                              
 BEGIN            
   select @uPupilId = uPupilId from t_TestDrive_Member_Pupil_ExternalSourceMapping where iMainclientId=@iMainClientId and uPupilExternalSourceId = @vExternalPupilId                              
   Update t_TestDrive_Member_Pupil_ExternalSourceMapping set dtModifiedOn=GETDATE() where iMainclientId=@iMainClientId and uPupilExternalSourceId = @vExternalPupilId                        
   Update T set T.vFirstName =Vorname,T.vName =Name,T.vEmail = EMail, T.dtModifiedOn = GETDATE(),                             
   T.iGenderId = case when (Geschlecht='f') then 1 when (Geschlecht='m') then 0  END                             
   from t_TestDrive_Member_Pupil T,OPENJSON(@vPupilDataJson) with                              
   (Vorname nvarchar(max),Name nvarchar(max),EMail nvarchar(max),Geschlecht char(1)) where uPupilId=@uPupilId                           
                           
   update t_TestDrive_Member_School_Pupil set cIsDeleted ='Y' where uPupilId=@uPupilId  and uSchoolId not in(select uSchoolId from t_TestDrive_Member_school_ExternalSourceMapping  where iMainclientId =@iMainClientId and  uSchoolExternalSourceId in(select 

  
ID from openjson(@vSchoolDataJson)     
   with (Id nvarchar(50) '$.ID')))                     
   and cIsDeleted ='N'              
                        
   declare  Cur_School cursor for select value from openjson(@vSchoolDataJson)                        
     open Cur_School                        
      fetch next from Cur_School into @vSubData                        
   WHILE(@@FETCH_STATUS<>-1)                        
    BEGIN                        
select @vExternalSchoolId = ID, @cIsAdmin = case when (isAdmin='false') then 'N' when (isAdmin='true') then 'Y'  END  from openjson(@vSubData) with (ID nvarchar(50), isAdmin nvarchar(50))                        
    if exists(select * from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = @vExternalSchoolId and iMainclientId =@iMainClientId)                        
    BEGIN                        
      select @uSchoolId = uSchoolId from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = @vExternalSchoolId  and iMainclientId = @iMainClientId                       
       if exists(select * from t_TestDrive_Member_School_Pupil where uPupilId =@uPupilId and uSchoolId=@uSchoolId)                        
    BEGIN                        
     update t_TestDrive_Member_School_Pupil set cIsDeleted ='N', cIsAdmin =@cIsAdmin where uPupilId =@uPupilId and uSchoolId=@uSchoolId                        
    END                        
    ELSE                        
      BEGIN                        
       insert into t_TestDrive_Member_School_Pupil values(newid(),@uPupilId,@uSchoolId,'N',@cIsAdmin)                        
     END                        
     END                        
     ELSE                        
     BEGIN                        
    --rollback transaction                        
    print 'rollback'                        
     END                        
    fetch next from Cur_School into @vSubData                        
    END                        
    Close Cur_School                        
    Deallocate Cur_School                        
                        
                                   
 END                              
 ELSE                              
   BEGIN                              
   set @uPupilId=NEWID();                              
    insert into t_TestDrive_Member_Pupil_ExternalSourceMapping(uPupilId,iMainClientId,uPupilExternalSourceIdGuid,uPupilExternalSourceId,uClassId,dtCreatedOn,dtModifiedOn)                              
   select @uPupilId,  @iMainClientId, newid(),ID,newid(), getdate(),getdate()  from OPENJSON(@vPupilDataJson) with (ID nvarchar(500))                               
                                
    Insert into t_TestDrive_Member_Pupil(uPupilId,iMainClientId, vFirstName,vName,vEmail,iGenderId,dtCreatedOn,dtModifiedOn,cIsExternalMember) select                               
     @uPupilId,@iMainClientId, Vorname,Name,EMail,case when (Geschlecht='f') then 1 when (Geschlecht='m') then 0  END ,GETDATE(),GETDATE(),'Y' from                              
    OPENJSON(@vPupilDataJson) with (Vorname nvarchar(max),Name nvarchar(max),EMail nvarchar(50),Ort nvarchar(500) ,Geschlecht char(1))                               
                           
    declare  Cur_School cursor for select value from openjson(@vSchoolDataJson)                        
     open Cur_School                        
      fetch next from Cur_School into @vSubData                        
   WHILE(@@FETCH_STATUS<>-1)                        
    BEGIN                        
    select @vExternalSchoolId = ID, @cIsAdmin = case when (isAdmin='false') then 'N' when (isAdmin='true') then 'Y'  END  from openjson(@vSubData) with (ID nvarchar(50), isAdmin nvarchar(50))                        
    if exists(select * from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = @vExternalSchoolId and iMainclientId = @iMainClientId )                        
    BEGIN                        
     select @uSchoolId = uSchoolId from t_TestDrive_Member_school_ExternalSourceMapping where uSchoolExternalSourceId = @vExternalSchoolId and iMainclientId = @iMainClientId                       
     insert into t_TestDrive_Member_School_Pupil values(newid(),@uPupilId,@uSchoolId,'N',@cIsAdmin)                        
    END                        
    ELSE                        
    BEGIN                        
    --rollback transaction                        
    print 'rollback'                        
    END                        
    fetch next from Cur_School into @vSubData                        
    END                    
    Close Cur_School                        
    Deallocate Cur_School                        
     END                        
 END                     
                     
                      
 select(                                  
   select  uSchoolId,vSchoolName,iStateId,iTitleId,vFirstName,vName,vStreet,iZIPCode,vTown,vPhone,vEmail,vPassword,dtCreatedOn,dtModifiedOn,vIPLastModifiedFrom,                          
dtWhenLoginlEmailSent,                          
cIsDeleted,                          
iMainClientId,                          
iLanguageId,                          
cIsTestSchool,                          
iSchoolTypeId,                          
cHasLearnCoacher,                          
iProfilePictureFileSize,                          
iProfilePictureFileVersion,                          
vProfilePictureFileType,                          
vPhonePrivate,                          
uUserId,                          
vAdministrationIP,                          
vTestIP,                          
vPasswordHash,                          
uLastVisitedTeacherId for json path, include_null_values, without_array_wrapper) as jsonresult                                    
   from t_TestDrive_Member_School  where uSchoolId in (select uSchoolId from t_TestDrive_Member_school_ExternalSourceMapping where iMainclientId=@iMainClientId and uSchoolExternalSourceId in(select ID from openjson(@vSchoolDataJson) with (Id nvarchar(50)


   
'$.ID')))                      
                     
                               
 select(                                    
   select   uPupilId,                            
iProfileCode,                            
iGenderId,                            
vFirstName,                            
vName,                            
vBirthdate,                            
cIsForeignLanguage,                            
vEmail,                            
vPassword,   
vIPLastModifiedFrom,                            
dtCreatedOn,                            
dtModifiedOn,                            
vStreet,                            
iZip,                            
vTown,                            
iProfessionId,                            
dtLearncoacherPasswordCreatedOn,                            
vLearnCoacherPassword,                            
iProfilePictureFileSize,                       
iProfilePictureFileVersion,                            
vProfilePictureFileType,                            
dtPasswordCreatedOn,                            
dtWhenLearnCoacherLoginHasBeenBilled,                            
iPupilTypeId,                            
vPhonePrivate,                            
vSSN,                            
uJobFieldId,                            
uJobLevelId,                            
uUserId,                            
iLanguageId,                            
iMainClientId,                            
vPasswordHash,                            
vUserName                       
   for json path, include_null_values, without_array_wrapper) as jsonresult                                      
   from t_TestDrive_Member_Pupil P  where uPupilId =@uPupilId                        
            
            
   --select (                                        
   -- select uSchoolPupilId,uPupilId,uSchoolId,cIsDeleted,cIsAdmin                         
   --for json path, include_null_values, without_array_wrapper )as jsonresult                                      
   --from t_TestDrive_Member_School_Pupil P where p.uPupilId =@uPupilId     
   SELECT (                                    
    SELECT   
 uSchoolPupilId,      
 SP.uPupilId,      
 SP.uSchoolId,      
 SP.cIsDeleted,      
 cIsAdmin,MP.vFirstName,MP.vName                     
   FOR JSON PATH, INCLUDE_NULL_VALUES, WITHOUT_ARRAY_WRAPPER )AS jsonresult                                  
    FROM t_TestDrive_Member_School_Pupil SP    
 INNER JOIN t_TestDrive_Member_Pupil MP ON SP.uPupilId=MP.uPupilId    
 INNER JOIN t_TestDrive_Member_School S ON s.uSchoolId=SP.uSchoolId       
   WHERE SP.uPupilId =@uPupilId          
                    
select(                                          
    SELECT CURRENT_TRANSACTION_ID() [TransactionId]  for json path, include_null_values, without_array_wrapper) as jsonresult                                     
                    
 Commit

GO

ALTER PROCEDURE [dbo].[Proc_LearnCoacher_Planner_SaveCurriculumDetails](  
@strXml ntext,  
@cismultiplecompetencypresent char(1),  
@cisfileuploaded char(1),  
@cisnewcurriculum char(1)  
)  
as   
/********************************************************************************************                
  
Created By:  Arun Menon       
Created Date: 28/10/2015        
Description:  New proc to add/edit Curriculum  Data         
  
 Modified By: Arvind K                                       
 Modified Date: 12/08/2020                                     
 Description: Included default value for uModifiedByUserId column              
  
********************************************************************************************/    
  
BEGIN  
 DECLARE @strmainxml XML = @strXml;  
 DECLARE @uCurriculumId uniqueidentifier;  
 DECLARE @iMainClientId int;  
 DECLARE @vNotes nvarchar(MAX);  
 DECLARE @iSubSubjectId int;  
 DECLARE @iCategoryId int;  
 DECLARE @cIsDeleted char(1);  
 DECLARE @dtCreatedOn datetime;  
 DECLARE @uUserId uniqueidentifier;  
  
 DECLARE @vFileName nvarchar(250);  
 DECLARE @vFileVersion char(1);  
 DECLARE @vFileType nvarchar(10);  
 DECLARE @uCurriculumCompetencyId uniqueidentifier;  
 DECLARE @iCategoryCompetencyId int;  
 DECLARE @uSegmentId uniqueidentifier;  
 DECLARE @dtSegmentCurriculumDate datetime;  
  
  if(@cisnewcurriculum='Y')  
  begin  
    set @uCurriculumId= newid();  
  
    insert into t_LearnCoacher_Planner_Curriculum  (uCurriculumId,	iMainClientId,	vNotes,	iSubSubjectId,	iCategoryId,	cIsDeleted,	dtCreatedOn,	dtModifiedOn,	uUserId) 

     SELECT   
     @uCurriculumId,  
     col.value('(@iMainClientId)[1]', 'int'),  
     col.value('(@vNotes)[1]', 'nvarchar(MAX)'),  
     col.value('(@iSubSubjectId)[1]', 'int'),  
     col.value('(@iCategoryId)[1]', 'int'),  
     col.value('(@cIsDeleted)[1]', 'char(1)'),  
     col.value('(@dtCreatedOn)[1]', 'datetime'),  
     getdate(),  
     col.value('(@uUserId)[1]', 'uniqueidentifier')  
  
    FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col);  
          
     if(@cisfileuploaded='Y')  
       Begin  
      DECLARE cur_attachments CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
        SELECT   
         col.value('(@vFileName)[1]','nvarchar(250)'),  
         col.value('(@vFileVersion)[1]','char(1)'),  
         col.value('(@vFileType)[1]','nvarchar(10)')  
  
        FROM @strmainxml.nodes('/CurriculumData/CurriculumAttachments/CurriculumAttachment') tab(col)  
       OPEN cur_attachments  
       FETCH NEXT FROM cur_attachments INTO @vFileName, @vFileVersion,@vFileType  
       WHILE @@FETCH_STATUS<>-1  
        begin  
         insert into t_LearnCoacher_Planner_Curriculum_Attachment   
         values(newid(),@uCurriculumId,@vFileName,@vFileType,@vFileVersion,'N');  
         FETCH NEXT FROM cur_attachments INTO  @vFileName, @vFileVersion,@vFileType  
        end  
       CLOSE cur_attachments  
       DEALLOCATE cur_attachments  
       End  
  
      if(@cismultiplecompetencypresent='Y')  
      Begin  
       DECLARE cur_competencies CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
         SELECT   
          col.value('(@iCategoryCompetencyId)[1]','int')  
               
        FROM @strmainxml.nodes('/CurriculumData/CurriculumCompetencies/CurriculumCompetency') tab(col)  
        OPEN cur_competencies  
        FETCH NEXT FROM cur_competencies INTO @iCategoryCompetencyId  
        WHILE @@FETCH_STATUS<>-1  
         begin  
          insert into t_LearnCoacher_Planner_Curriculum_Competency   
          values(newid(),@uCurriculumId,@iCategoryCompetencyId);  
          FETCH NEXT FROM cur_competencies INTO  @iCategoryCompetencyId  
         end  
        CLOSE cur_competencies  
        DEALLOCATE cur_competencies  
        End  
  
    insert into t_LearnCoacher_Planner_Segment_Curriculum  
      SELECT   
      newid(),  
      @uCurriculumId,  
      col.value('(@uSegmentId)[1]', 'uniqueidentifier'),  
      col.value('(@dtSegmentCurriculumDate)[1]', 'datetime')  
  
      FROM @strmainxml.nodes('/CurriculumData/CurriculumSegments/CurriculumSegment') tab(col);  
    end  
    
   else  
  
    begin  
    update t_LearnCoacher_Planner_Curriculum set iMainClientId=col.value('(@iMainClientId)[1]', 'int'),vNotes=col.value('(@vNotes)[1]', 'nvarchar(MAX)'),  
    iSubSubjectId= col.value('(@iSubSubjectId)[1]', 'int'),  
    iCategoryId=col.value('(@iCategoryId)[1]', 'int'),dtModifiedOn=GETDATE(),uUserId=col.value('(@uUserId)[1]', 'uniqueidentifier')   
    FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col)  
    where uCurriculumId=col.value('(@uCurriculumId)[1]', 'uniqueidentifier');  
  
    select @uCurriculumId=col.value('(@uCurriculumId)[1]', 'uniqueidentifier') FROM @strmainxml.nodes('/CurriculumData/CurriculumDetails/Curriculum') tab(col);  
  
       if(@cisfileuploaded='Y')  
       Begin  
      DECLARE cur_attachments CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
        SELECT   
         col.value('(@uCurriculumId)[1]', 'uniqueidentifier'),  
         col.value('(@vFileName)[1]','nvarchar(250)'),  
         col.value('(@vFileVersion)[1]','char(1)'),  
         col.value('(@vFileType)[1]','nvarchar(10)')  
  
        FROM @strmainxml.nodes('/CurriculumData/CurriculumAttachments/CurriculumAttachment') tab(col)  
       OPEN cur_attachments  
       FETCH NEXT FROM cur_attachments INTO @uCurriculumId,@vFileName, @vFileVersion,@vFileType  
       WHILE @@FETCH_STATUS<>-1  
        begin  
         insert into t_LearnCoacher_Planner_Curriculum_Attachment   
         values(newid(),@uCurriculumId,@vFileName,@vFileType,@vFileVersion,'N');  
         FETCH NEXT FROM cur_attachments INTO  @uCurriculumId,@vFileName, @vFileVersion,@vFileType  
        end  
       CLOSE cur_attachments  
       DEALLOCATE cur_attachments  
       End  
        
          if(@cismultiplecompetencypresent='Y')  
      Begin  
       DECLARE cur_competencies CURSOR STATIC FORWARD_ONLY READ_ONLY FOR  
         SELECT   
          col.value('(@uCurriculumCompetencyId)[1]', 'uniqueidentifier'),  
          col.value('(@iCategoryCompetencyId)[1]','int')  
               
        FROM @strmainxml.nodes('/CurriculumData/CurriculumCompetencies/CurriculumCompetency') tab(col)  
        OPEN cur_competencies  
        FETCH NEXT FROM cur_competencies INTO @uCurriculumCompetencyId,@iCategoryCompetencyId  
        WHILE @@FETCH_STATUS<>-1  
         begin  
             if(@uCurriculumCompetencyId='00000000-0000-0000-0000-000000000000')  
            begin  
               insert into t_LearnCoacher_Planner_Curriculum_Competency   
               values(newid(),@uCurriculumId,@iCategoryCompetencyId);  
            end  
          else  
             begin  
                update t_LearnCoacher_Planner_Curriculum_Competency set iCategoryCompetencyId=@iCategoryCompetencyId  
                where uCurriculumCompetencyId=@uCurriculumCompetencyId;  
             end  
          FETCH NEXT FROM cur_competencies INTO  @uCurriculumCompetencyId,@iCategoryCompetencyId  
         end  
        CLOSE cur_competencies  
        DEALLOCATE cur_competencies  
        End  
  
  
    end  
  
   select * from t_LearnCoacher_Planner_Curriculum where uCurriculumId=@uCurriculumId;  
   select * from t_LearnCoacher_Planner_Curriculum_Attachment where uCurriculumId=@uCurriculumId;  
   select * from t_LearnCoacher_Planner_Curriculum_Competency where uCurriculumId=@uCurriculumId;  
   select * from t_LearnCoacher_Planner_Curriculum_CompetencyCandoItem where uCurriculumId=@uCurriculumId;  
   select * from t_LearnCoacher_Planner_Segment_Curriculum where uCurriculumId=@uCurriculumId;  
   
END 

